<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPL Explorer - Parse.ly Analytics Intelligence</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --parsely-green: #70A452;
            --parsely-green-dark: #5c8f43;
            --parsely-green-light: #edf5e8;
            --parsely-blue: #0066cc;
            --parsely-blue-light: #e6f2ff;
            --parsely-navy: #1a2332;
            --parsely-gray-50: #fbfbfb;
            --parsely-gray-100: #e9ecef;
            --parsely-gray-200: #dee2e6;
            --parsely-gray-300: #ced4da;
            --parsely-gray-400: #adb5bd;
            --parsely-gray-600: #6c757d;
            --parsely-gray-700: #495057;
            --parsely-gray-800: #343a40;
            --parsely-gray-900: #212529;
            --accent-orange: #ff6b35;
            --accent-purple: #6a4c93;
            --accent-teal: #17a2b8;
            --accent-red: #dc3545;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--parsely-gray-50);
            color: var(--parsely-gray-900);
            line-height: 1.6;
            padding-top: 54px;
        }

        .parsely-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1100;
            background: rgba(255,255,255,0.97);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .parsely-nav-content { max-width: 1400px; margin: 0 auto; padding: 0.75rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .parsely-nav-logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; color: var(--parsely-gray-900); }
        .parsely-nav-logo img { height: 24px; width: auto; }
        .parsely-nav-divider { font-size: 0.875rem; font-weight: 600; color: var(--parsely-gray-600); border-left: 1px solid var(--parsely-gray-200); padding-left: 0.75rem; }
        .parsely-nav-links { display: flex; align-items: center; gap: 0.25rem; }
        .parsely-nav-link { padding: 0.5rem 0.875rem; font-size: 0.875rem; font-weight: 500; color: var(--parsely-gray-600); text-decoration: none; border-radius: 6px; transition: all 0.2s ease; }
        .parsely-nav-link:hover { color: var(--parsely-green); background: var(--parsely-green-light); }
        .parsely-nav-link.active { color: var(--parsely-green-dark); background: var(--parsely-green-light); font-weight: 600; }

        .app-layout { display: flex; min-height: calc(100vh - 54px); }

        .sidebar {
            width: 280px; background: white; border-right: 1px solid var(--parsely-gray-200);
            padding: 1.5rem 0; position: fixed; top: 54px; height: calc(100vh - 54px);
            overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }
        .logo-container { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid var(--parsely-gray-200); margin-bottom: 1.5rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 40px; height: 40px; background: var(--parsely-green); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1.25rem; }
        .logo-text { display: flex; flex-direction: column; }
        .logo-title { font-size: 1.125rem; font-weight: 700; color: var(--parsely-gray-900); line-height: 1.2; }
        .logo-subtitle { font-size: 0.75rem; color: var(--parsely-gray-600); font-weight: 500; }

        .sidebar-section { padding: 0 1.5rem; margin-bottom: 1.5rem; }
        .sidebar-section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--parsely-gray-600); margin-bottom: 0.75rem; }

        .nav-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; margin: 0.25rem 0;
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
            font-size: 0.875rem; font-weight: 500; color: var(--parsely-gray-700);
        }
        .nav-item:hover { background: var(--parsely-gray-50); color: var(--parsely-gray-900); }
        .nav-item.active { background: var(--parsely-green-light); color: var(--parsely-green-dark); font-weight: 600; }
        .nav-icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }

        .main-content { margin-left: 280px; flex: 1; padding: 2rem; min-height: 100vh; }

        .header { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--parsely-gray-900); }

        .status-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--parsely-green-light); border: 1px solid var(--parsely-green); border-radius: 20px; font-size: 0.875rem; font-weight: 600; color: var(--parsely-green-dark); }
        .pulse { width: 8px; height: 8px; background: var(--parsely-green); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }

        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--parsely-green); color: white; }
        .btn-primary:hover { background: var(--parsely-green-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(112,164,82,0.3); }
        .btn-secondary { background: white; color: var(--parsely-gray-700); border: 1px solid var(--parsely-gray-300); }
        .btn-secondary:hover { background: var(--parsely-gray-50); border-color: var(--parsely-gray-400); }

        .content-section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--parsely-gray-100); }
        .section-title { font-size: 1.25rem; font-weight: 700; color: var(--parsely-gray-900); }

        .loading-container { text-align: center; padding: 4rem 2rem; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid var(--parsely-green-light); border-top-color: var(--parsely-green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 1rem; color: var(--parsely-gray-700); font-weight: 500; }

        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .metric-card { background: var(--parsely-gray-50); border: 1px solid var(--parsely-gray-200); border-radius: 10px; padding: 1.5rem; transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--parsely-green); }
        .metric-label { font-size: 0.813rem; text-transform: uppercase; color: var(--parsely-gray-600); margin-bottom: 0.5rem; font-weight: 600; letter-spacing: 0.5px; }
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--parsely-gray-900); margin-bottom: 0.5rem; }

        .data-table-container { overflow-x: auto; margin-top: 1.5rem; border-radius: 8px; border: 1px solid var(--parsely-gray-200); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--parsely-gray-200); font-size: 0.875rem; }
        .data-table th { background: var(--parsely-gray-50); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; color: var(--parsely-gray-700); letter-spacing: 0.5px; cursor: pointer; user-select: none; white-space: nowrap; }
        .data-table th:hover { background: var(--parsely-gray-100); }
        .data-table tbody tr { transition: background 0.2s ease; }
        .data-table tbody tr:hover { background: var(--parsely-green-light); }

        .chart-container { position: relative; height: 350px; margin-top: 1.5rem; }

        .segments-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem; }
        .segment-panel { background: var(--parsely-gray-50); border: 1px solid var(--parsely-gray-200); border-radius: 10px; padding: 1.5rem; }
        .segment-panel-title { font-size: 1rem; font-weight: 700; color: var(--parsely-gray-900); margin-bottom: 1rem; }
        .segment-chips { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .segment-chip { padding: 0.5rem 1rem; background: white; border: 2px solid var(--parsely-gray-300); border-radius: 20px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem; }
        .segment-chip:hover { border-color: var(--parsely-green); transform: scale(1.05); }
        .segment-chip.selected { background: var(--parsely-green); color: white; border-color: var(--parsely-green); }
        .segment-count { background: rgba(0,0,0,0.1); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; }
        .segment-chip.selected .segment-count { background: rgba(255,255,255,0.3); }

        .cross-segment-info { margin-top: 1.5rem; padding: 1rem; background: var(--parsely-blue-light); border: 1px solid var(--parsely-blue); border-radius: 8px; }
        .cross-segment-title { font-size: 0.875rem; font-weight: 700; color: var(--parsely-blue); margin-bottom: 0.5rem; }
        .cross-segment-stats { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.75rem; }
        .cross-segment-stat { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .cross-segment-stat-value { font-weight: 700; color: var(--parsely-blue); }

        .sankey-container { width: 100%; min-height: 700px; margin-top: 1.5rem; }

        /* Tooltip for conversion breakdown */
        .conv-tooltip {
            position: absolute; z-index: 999; background: var(--parsely-gray-900); color: white;
            padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.8rem; pointer-events: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25); white-space: nowrap;
        }
        .conv-tooltip::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid var(--parsely-gray-900);
        }

        /* Step selector cards */
        .step-cards { display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0; }
        .step-card {
            flex: 1; min-width: 180px; padding: 1.25rem; border: 2px solid var(--parsely-gray-200);
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease; text-align: center;
        }
        .step-card:hover { border-color: var(--parsely-green); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .step-card.selected { border-color: var(--parsely-green); background: var(--parsely-green-light); }
        .step-card-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .step-card-label { font-weight: 700; font-size: 0.95rem; }
        .step-card-count { font-size: 0.8rem; color: var(--parsely-gray-600); margin-top: 0.25rem; }

        /* Toggle buttons */
        .toggle-group { display: inline-flex; border: 2px solid var(--parsely-gray-200); border-radius: 8px; overflow: hidden; margin: 1rem 0; }
        .toggle-btn { padding: 0.6rem 1.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; border: none; background: white; color: var(--parsely-gray-700); transition: all 0.2s; }
        .toggle-btn.active { background: var(--parsely-green); color: white; }

        /* Problem/Solution panels */
        .panel-problem { background: #fef2f2; border: 1px solid #fca5a5; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .panel-solution { background: #f0fdf4; border: 1px solid #86efac; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .panel-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem; }
        .panel-problem .panel-title { color: #dc2626; }
        .panel-solution .panel-title { color: #16a34a; }

        /* Before/After comparison */
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem; }
        .comparison-card { border-radius: 12px; padding: 1.5rem; }
        .comparison-before { background: #fef2f2; border: 2px solid #fca5a5; }
        .comparison-after { background: #f0fdf4; border: 2px solid #86efac; }

        /* Journey timeline */
        .journey-timeline { position: relative; padding: 1rem 0 1rem 2.5rem; }
        .journey-timeline::before { content: ''; position: absolute; left: 1rem; top: 0; bottom: 0; width: 3px; background: linear-gradient(to bottom, #dc2626, #70A452); border-radius: 2px; }
        .timeline-step { position: relative; margin-bottom: 1.25rem; padding: 0.85rem 1rem; background: white; border-radius: 10px; border: 1px solid var(--parsely-gray-200); box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        .timeline-step::before { content: ''; position: absolute; left: -1.85rem; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius: 50%; border: 3px solid; background: white; }
        .timeline-step.step-main::before { border-color: #dc2626; }
        .timeline-step.step-cross::before { border-color: #f59e0b; }
        .timeline-step.step-unified::before { border-color: #70A452; }
        .timeline-step .step-time { font-size: 0.75rem; font-weight: 700; color: var(--parsely-gray-500); font-family: monospace; }
        .timeline-step .step-domain { font-size: 0.8rem; font-weight: 700; font-family: monospace; margin: 0.2rem 0; }
        .timeline-step .step-action { font-size: 0.85rem; color: var(--parsely-gray-700); }
        .timeline-step .step-id { font-size: 0.7rem; color: var(--parsely-gray-400); font-family: monospace; margin-top: 0.2rem; }
        .timeline-break { position: relative; margin: 0.5rem 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; }
        .timeline-break-label { font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.6rem; border-radius: 4px; }
        .timeline-break-label.break-red { background: #fef2f2; color: #dc2626; border: 1px solid #fca5a5; }
        .timeline-break-label.break-green { background: #f0fdf4; color: #16a34a; border: 1px solid #86efac; }

        /* Code snippet */
        .code-block { background: #1e293b; color: #e2e8f0; border-radius: 10px; padding: 1.25rem; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 0.8rem; line-height: 1.7; overflow-x: auto; margin: 1rem 0; }
        .code-block .code-comment { color: #64748b; }
        .code-block .code-keyword { color: #7dd3fc; }
        .code-block .code-string { color: #86efac; }
        .code-block .code-func { color: #c4b5fd; }
        .code-block .code-var { color: #fbbf24; }
        .code-tab-bar { display: flex; gap: 0; margin-bottom: 0; }
        .code-tab { padding: 0.5rem 1.25rem; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--parsely-gray-200); border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; background: var(--parsely-gray-100); color: var(--parsely-gray-600); }
        .code-tab.active { background: #1e293b; color: #e2e8f0; border-color: #1e293b; }

        /* Predefined metric option cards */
        .preset-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .preset-card {
            padding: 1.25rem; border: 2px solid var(--parsely-gray-200); border-radius: 12px;
            cursor: pointer; transition: all 0.2s ease; background: white;
        }
        .preset-card:hover { border-color: var(--parsely-green); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .preset-card.active { border-color: var(--parsely-green); background: var(--parsely-green-light); }
        .preset-card-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 0.25rem; }
        .preset-card-desc { font-size: 0.8rem; color: var(--parsely-gray-600); }

        /* Gauge chart containers */
        .gauge-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
        .gauge-card { text-align: center; background: var(--parsely-gray-50); border: 1px solid var(--parsely-gray-200); border-radius: 12px; padding: 1.5rem; }
        .gauge-label { font-size: 0.85rem; font-weight: 700; color: var(--parsely-gray-800); margin-top: 0.5rem; }
        .gauge-value { font-size: 1.5rem; font-weight: 800; color: var(--parsely-green-dark); }

        /* World map */
        .world-map-container { width: 100%; height: 520px; margin-top: 1.5rem; border: 1px solid var(--parsely-gray-200); border-radius: 12px; overflow: hidden; background: #f8fafc; }
        .world-map-container svg { width: 100%; height: 100%; }

        /* Drill-down panel */
        .drill-panel { margin-top: 1.5rem; padding: 1.25rem; background: var(--parsely-blue-light); border: 1px solid var(--parsely-blue); border-radius: 10px; }
        .drill-title { font-size: 0.9rem; font-weight: 700; color: var(--parsely-blue); margin-bottom: 0.75rem; }
        .drill-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .drill-chip { padding: 0.4rem 0.8rem; background: white; border: 1px solid var(--parsely-blue); border-radius: 16px; font-size: 0.8rem; font-weight: 600; color: var(--parsely-blue); }

        @media (max-width: 1024px) {
            .sidebar { width: 240px; }
            .main-content { margin-left: 240px; }
            .segments-container, .comparison-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Article thumbnail */
        .article-thumb {
            width: 48px; height: 48px; border-radius: 6px; object-fit: cover;
            background: linear-gradient(135deg, var(--parsely-green-light), var(--parsely-blue-light));
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            font-size: 1.25rem; color: var(--parsely-gray-400);
        }
        .article-row-cell { display: flex; align-items: center; gap: 0.75rem; }

        /* Scorecard styles */
        .scorecard-explanation { background: var(--parsely-blue-light); border: 1px solid var(--parsely-blue); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .scorecard-explanation h3 { color: var(--parsely-blue); margin-bottom: 1rem; }
        .score-scale { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin: 1rem 0; }
        .score-item { text-align: center; padding: 1rem; border-radius: 8px; }
        .score-item.score-1 { background: rgba(220, 53, 69, 0.1); }
        .score-item.score-2 { background: rgba(255, 107, 53, 0.1); }
        .score-item.score-3 { background: rgba(255, 193, 7, 0.1); }
        .score-item.score-4 { background: rgba(112, 164, 82, 0.1); }
        .score-item.score-5 { background: rgba(40, 167, 69, 0.1); }
        .score-number { font-size: 2rem; font-weight: 700; }
        .score-1 .score-number { color: #dc3545; }
        .score-2 .score-number { color: #ff6b35; }
        .score-3 .score-number { color: #ffc107; }
        .score-4 .score-number { color: #70A452; }
        .score-5 .score-number { color: #28a745; }
        .score-label { font-size: 0.75rem; font-weight: 600; margin-top: 0.25rem; }
        .score-percentage { font-size: 0.7rem; color: var(--parsely-gray-600); margin-top: 0.25rem; }
        .scorecard-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .scorecard-table th, .scorecard-table td { padding: 1rem; text-align: center; border: 1px solid var(--parsely-gray-200); font-size: 0.875rem; }
        .scorecard-table th { background: var(--parsely-gray-50); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; color: var(--parsely-gray-700); }
        .scorecard-table td:first-child { text-align: left; font-weight: 600; }
        .score-cell { display: inline-flex; align-items: center; justify-content: center; padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 700; min-width: 36px; font-size: 0.9rem; }
        .score-cell.score-1 { background: rgba(220,53,69,0.15); color: #dc3545; }
        .score-cell.score-2 { background: rgba(255,107,53,0.15); color: #ff6b35; }
        .score-cell.score-3 { background: rgba(255,193,7,0.15); color: #d39e00; }
        .score-cell.score-4 { background: rgba(112,164,82,0.15); color: #70A452; }
        .score-cell.score-5 { background: rgba(40,167,69,0.15); color: #28a745; }
        .avg-score { font-size: 1.1rem; font-weight: 800; }
        .avg-score.high { color: #28a745; }
        .avg-score.mid { color: #ffc107; }
        .avg-score.low { color: #dc3545; }
        .scorecard-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
        .scorecard-stat { background: white; border: 1px solid var(--parsely-gray-200); border-radius: 10px; padding: 1.25rem; text-align: center; }
        .scorecard-stat-value { font-size: 1.75rem; font-weight: 800; }
        .scorecard-stat-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--parsely-gray-600); margin-top: 0.25rem; letter-spacing: 0.5px; }
    </style>
</head>
<body>
    <nav class="parsely-nav">
        <div class="parsely-nav-content">
            <a href="index.html" class="parsely-nav-logo">
                <img src="https://www.parse.ly/wp-content/uploads/sites/6/2023/12/parsely-logo.svg" alt="Parse.ly" />
                <span class="parsely-nav-divider">Demo Hub</span>
            </a>
            <div class="parsely-nav-links">
                <a href="index.html" class="parsely-nav-link">Home</a>
                <a href="dpl-verticals.html" class="parsely-nav-link active">DPL Explorer</a>
                <a href="api-browser.html" class="parsely-nav-link">API Browser</a>
                <a href="personalization-demo.html" class="parsely-nav-link">Personalization</a>
            </div>
        </div>
    </nav>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ═══════════════════════════════════════════════
        //  CONSTANTS
        // ═══════════════════════════════════════════════

        const ARTICLE_TITLES = [
            "Breaking: Global Climate Summit Reaches Historic Agreement",
            "Tech Giants Report Record Quarterly Earnings",
            "Local Team Clinches Championship Title in Overtime",
            "New Study Reveals Benefits of Mediterranean Diet",
            "Housing Market Shows Signs of Cooling in Major Cities",
            "SpaceX Launches Next-Gen Satellite Constellation",
            "Political Tensions Rise Ahead of Midterm Elections",
            "Streaming Wars: Netflix vs Disney+ Market Analysis",
            "AI Revolution: How Machine Learning Changes Healthcare",
            "Olympic Athletes Prepare for Summer Games",
            "Cryptocurrency Regulation Bill Passes Senate Committee",
            "Wildfire Season Threatens Western Communities",
            "Electric Vehicle Sales Surge Past Gas Cars in Europe",
            "Supreme Court Ruling Reshapes Privacy Laws",
            "Broadway Returns: Record-Breaking Season Opens",
            "Cybersecurity Experts Warn of New Phishing Campaign",
            "World Cup Qualifier Results Shake Up Rankings",
            "Remote Work Trends: Companies Rethink Office Space",
            "Pandemic Recovery: Tourism Industry Bounces Back",
            "Investigative Report: Inside the Opioid Crisis"
        ];

        const COUNTRIES = [
            { code: 'US', name: 'United States', isoN: 840 },
            { code: 'GB', name: 'United Kingdom', isoN: 826 },
            { code: 'CA', name: 'Canada', isoN: 124 },
            { code: 'DE', name: 'Germany', isoN: 276 },
            { code: 'FR', name: 'France', isoN: 250 },
            { code: 'AU', name: 'Australia', isoN: 36 },
            { code: 'BR', name: 'Brazil', isoN: 76 },
            { code: 'IN', name: 'India', isoN: 356 },
            { code: 'JP', name: 'Japan', isoN: 392 },
            { code: 'MX', name: 'Mexico', isoN: 484 },
            { code: 'ES', name: 'Spain', isoN: 724 },
            { code: 'IT', name: 'Italy', isoN: 380 },
            { code: 'NL', name: 'Netherlands', isoN: 528 },
            { code: 'SE', name: 'Sweden', isoN: 752 },
            { code: 'KR', name: 'South Korea', isoN: 410 }
        ];

        const AUDIENCE_SEGMENTS = ['Subscribers', 'Newsletter Readers', 'Social Followers', 'Search Visitors', 'Loyal Readers', 'New Visitors'];

        const AUDIENCE_GEO_MAP = {
            'Subscribers': ['US', 'GB', 'CA', 'AU', 'DE'],
            'Newsletter Readers': ['US', 'GB', 'FR', 'DE', 'NL', 'SE'],
            'Social Followers': ['US', 'BR', 'IN', 'MX', 'ES'],
            'Search Visitors': ['US', 'GB', 'CA', 'DE', 'FR', 'JP', 'AU', 'IN', 'KR'],
            'Loyal Readers': ['US', 'GB', 'CA', 'AU'],
            'New Visitors': ['US', 'GB', 'CA', 'DE', 'FR', 'AU', 'BR', 'IN', 'JP', 'MX', 'ES', 'IT', 'NL', 'SE', 'KR']
        };

        const CONVERSION_TYPES = ['subscription', 'newsletter', 'pdf_download'];
        const REFERRER_TYPES = ['Search', 'Social', 'AI Bots', 'Email', 'Newsletters', 'Push'];
        const LANDING_PAGES = ['Homepage', 'Contact', 'Campaign', 'Store'];
        const SUBDOMAINS = ['www.site.com', 'shop.site.com', 'paywall.site.com', 'subscribe.site.com'];

        // ═══════════════════════════════════════════════
        //  DATA GENERATION
        // ═══════════════════════════════════════════════

        const generateSampleData = () => {
            const sampleData = [];
            for (let i = 0; i < 800; i++) {
                const country = COUNTRIES[Math.floor(Math.random() * COUNTRIES.length)];
                const isConversion = Math.random() > 0.82;
                const convType = CONVERSION_TYPES[Math.floor(Math.random() * CONVERSION_TYPES.length)];
                const convValue = isConversion ? (convType === 'subscription' ? 29.99 + Math.random() * 70 : convType === 'newsletter' ? 0 : 5 + Math.random() * 15) : 0;
                const segment = AUDIENCE_SEGMENTS[Math.floor(Math.random() * AUDIENCE_SEGMENTS.length)];
                const articleIdx = Math.floor(Math.random() * ARTICLE_TITLES.length);
                const subdomain = SUBDOMAINS[Math.floor(Math.random() * SUBDOMAINS.length)];
                const visitorId = `visitor_${Math.floor(Math.random() * 200)}`;

                const subsCount = isConversion && convType === 'subscription' ? 1 : 0;
                const nlCount = isConversion && convType === 'newsletter' ? 1 : 0;
                const pdfCount = isConversion && convType === 'pdf_download' ? 1 : 0;

                sampleData.push({
                    action: ['pageview', 'heartbeat', 'vheartbeat'][Math.floor(Math.random() * 3)],
                    apikey: 'demoaccount.parsely.com',
                    engaged_time_inc: Math.floor(Math.random() * 300),
                    event_id: `0x${Math.random().toString(16).substr(2, 16)}`,
                    ip_country: country.code,
                    ip_city: ['New York', 'London', 'Berlin', 'Paris', 'Tokyo', 'Sydney', 'Mumbai', 'Toronto'][Math.floor(Math.random() * 8)],
                    metadata_title: ARTICLE_TITLES[articleIdx],
                    metadata_section: ['News', 'Sports', 'Politics', 'Tech', 'Culture'][Math.floor(Math.random() * 5)],
                    ref_category: ['direct', 'search', 'social', 'internal'][Math.floor(Math.random() * 4)],
                    ts_action: new Date(Date.now() - Math.random() * 86400000 * 7).toISOString(),
                    ua_browser: ['Chrome', 'Safari', 'Firefox', 'Edge'][Math.floor(Math.random() * 4)],
                    ua_devicetype: ['desktop', 'mobile', 'tablet'][Math.floor(Math.random() * 3)],
                    url: `https://site.com/article/${1000 + articleIdx}/`,
                    visitor_site_id: visitorId,
                    referrer_type: REFERRER_TYPES[Math.floor(Math.random() * REFERRER_TYPES.length)],
                    landing_page: LANDING_PAGES[Math.floor(Math.random() * LANDING_PAGES.length)],
                    content_depth: Math.floor(Math.random() * 5),
                    content_title: ARTICLE_TITLES[articleIdx],
                    conversion_type: isConversion ? convType : null,
                    conversion_value: convValue,
                    subdomain: subdomain,
                    original_visitor_id: visitorId,
                    passthrough_uid: subdomain !== 'www.site.com' ? visitorId : null,
                    extra_data: JSON.stringify({
                        conversion_breakdown: { subscriptions: subsCount, newsletters: nlCount, pdf_downloads: pdfCount },
                        audience_segment: segment,
                        geo_segment: country.code,
                        article_interest: 1 + Math.floor(Math.random() * 5),
                        article_engagement: 1 + Math.floor(Math.random() * 5),
                        purposeful_reach: 1 + Math.floor(Math.random() * 5),
                        conversion_rate_score: 1 + Math.floor(Math.random() * 5)
                    })
                });
            }
            return sampleData;
        };

        // ═══════════════════════════════════════════════
        //  JOURNEY DATA (hardcoded Sankey)
        // ═══════════════════════════════════════════════

        const JOURNEY_NODES = [
            // Stage 0 - Referrers
            { name: 'Search', stage: 0 },
            { name: 'Social', stage: 0 },
            { name: 'AI Bots', stage: 0 },
            { name: 'Email', stage: 0 },
            { name: 'Newsletters', stage: 0 },
            { name: 'Push', stage: 0 },
            // Stage 1 - Landings
            { name: 'Homepage', stage: 1 },
            { name: 'Contact', stage: 1 },
            { name: 'Campaign', stage: 1 },
            { name: 'Store', stage: 1 },
            // Stage 2 - Interest L1
            { name: 'News Article 1', stage: 2 },
            { name: 'News Article 2', stage: 2 },
            { name: 'Photo Gallery', stage: 2 },
            { name: 'PDF Download', stage: 2 },
            // Stage 3 - Interest L2
            { name: 'Sports Article 1', stage: 3 },
            { name: 'Politics Article 2', stage: 3 },
            { name: 'Video', stage: 3 },
            // Stage 4 - Interest L3
            { name: 'Sports Article', stage: 4 },
            { name: 'Politics Article', stage: 4 },
            // Stage 5 - Interest L4
            { name: 'Politics Article (Deep)', stage: 5 },
            // Conversion node
            { name: 'Conversion', stage: 6 }
        ];

        const buildJourneyLinks = () => {
            const links = [];
            // Stage 0 -> Stage 1 (Referrers to Landings)
            links.push({ source: 0, target: 6, value: 120 });  // Search -> Homepage
            links.push({ source: 0, target: 8, value: 80 });   // Search -> Campaign
            links.push({ source: 1, target: 6, value: 90 });   // Social -> Homepage
            links.push({ source: 1, target: 9, value: 40 });   // Social -> Store
            links.push({ source: 2, target: 6, value: 60 });   // AI Bots -> Homepage
            links.push({ source: 2, target: 7, value: 20 });   // AI Bots -> Contact
            links.push({ source: 3, target: 8, value: 70 });   // Email -> Campaign
            links.push({ source: 3, target: 6, value: 30 });   // Email -> Homepage
            links.push({ source: 4, target: 6, value: 50 });   // Newsletters -> Homepage
            links.push({ source: 4, target: 8, value: 40 });   // Newsletters -> Campaign
            links.push({ source: 5, target: 9, value: 35 });   // Push -> Store
            links.push({ source: 5, target: 6, value: 25 });   // Push -> Homepage

            // Total arriving at landings: HP=375, Contact=20, Campaign=190, Store=75 = 660
            // Stage 1 -> Stage 2 (Landings to Interest L1)
            // ~3% of landings convert directly
            links.push({ source: 6, target: 20, value: 11 });  // Homepage -> Conversion (3%)
            links.push({ source: 8, target: 20, value: 6 });   // Campaign -> Conversion (3%)
            links.push({ source: 9, target: 20, value: 2 });   // Store -> Conversion (3%)
            links.push({ source: 6, target: 10, value: 140 }); // Homepage -> News Article 1
            links.push({ source: 6, target: 11, value: 100 }); // Homepage -> News Article 2
            links.push({ source: 6, target: 12, value: 80 });  // Homepage -> Photo Gallery
            links.push({ source: 7, target: 13, value: 18 });  // Contact -> PDF Download
            links.push({ source: 8, target: 10, value: 90 });  // Campaign -> News Article 1
            links.push({ source: 8, target: 13, value: 60 });  // Campaign -> PDF Download
            links.push({ source: 9, target: 12, value: 40 });  // Store -> Photo Gallery
            links.push({ source: 9, target: 11, value: 30 });  // Store -> News Article 2

            // Stage 2 -> Stage 3 (Interest L1 to L2), ~5% convert
            links.push({ source: 10, target: 20, value: 12 }); // News Article 1 -> Conversion (5%)
            links.push({ source: 11, target: 20, value: 7 });  // News Article 2 -> Conversion (5%)
            links.push({ source: 12, target: 20, value: 6 });  // Photo Gallery -> Conversion (5%)
            links.push({ source: 13, target: 20, value: 4 });  // PDF Download -> Conversion (5%)
            links.push({ source: 10, target: 14, value: 100 }); // News Article 1 -> Sports Article 1
            links.push({ source: 10, target: 15, value: 80 });  // News Article 1 -> Politics Article 2
            links.push({ source: 11, target: 15, value: 60 });  // News Article 2 -> Politics Article 2
            links.push({ source: 11, target: 16, value: 50 });  // News Article 2 -> Video
            links.push({ source: 12, target: 16, value: 50 });  // Photo Gallery -> Video
            links.push({ source: 12, target: 14, value: 25 });  // Photo Gallery -> Sports Article 1
            links.push({ source: 13, target: 15, value: 40 });  // PDF Download -> Politics Article 2

            // Stage 3 -> Stage 4 (Interest L2 to L3), ~8% convert
            links.push({ source: 14, target: 20, value: 10 }); // Sports Article 1 -> Conversion
            links.push({ source: 15, target: 20, value: 14 }); // Politics Article 2 -> Conversion
            links.push({ source: 16, target: 20, value: 8 });  // Video -> Conversion
            links.push({ source: 14, target: 17, value: 80 }); // Sports Article 1 -> Sports Article
            links.push({ source: 15, target: 18, value: 100 }); // Politics Article 2 -> Politics Article
            links.push({ source: 16, target: 17, value: 35 }); // Video -> Sports Article
            links.push({ source: 16, target: 18, value: 30 }); // Video -> Politics Article

            // Stage 4 -> Stage 5 (Interest L3 to L4), ~12% convert
            links.push({ source: 17, target: 20, value: 14 }); // Sports Article -> Conversion
            links.push({ source: 18, target: 20, value: 16 }); // Politics Article -> Conversion
            links.push({ source: 17, target: 19, value: 30 }); // Sports Article -> Politics Article (Deep)
            links.push({ source: 18, target: 19, value: 60 }); // Politics Article -> Politics Article (Deep)

            // Stage 5 -> Conversion, ~25% convert
            links.push({ source: 19, target: 20, value: 22 }); // Politics Article (Deep) -> Conversion

            return links;
        };

        const JOURNEY_LINKS = buildJourneyLinks();

        // ═══════════════════════════════════════════════
        //  CROSS-DOMAIN DATA (hardcoded)
        // ═══════════════════════════════════════════════

        const CROSS_DOMAIN_TABLE = [
            { subdomain: 'www.site.com', description: 'Main content site', conversions: null, uniqueUsers: 12450, revenue: null, avgTimeToConvert: null },
            { subdomain: 'shop.site.com', description: 'E-commerce store', conversions: 342, uniqueUsers: 1850, revenue: 28940, avgTimeToConvert: '4m 32s' },
            { subdomain: 'paywall.site.com', description: 'Premium content', conversions: 567, uniqueUsers: 3200, revenue: 16443, avgTimeToConvert: '2m 15s' },
            { subdomain: 'subscribe.site.com', description: 'Newsletter subscription', conversions: 891, uniqueUsers: 4100, revenue: 44550, avgTimeToConvert: '1m 48s' }
        ];

        // ═══════════════════════════════════════════════
        //  APP COMPONENT
        // ═══════════════════════════════════════════════

        function App() {
            const [loading, setLoading] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [rawData, setRawData] = useState([]);
            const [activeView, setActiveView] = useState('journeys');

            const handleLoadData = () => {
                setLoading(true);
                setTimeout(() => {
                    const data = generateSampleData();
                    setRawData(data);
                    setDataLoaded(true);
                    setLoading(false);
                }, 2000);
            };

            return (
                <div className="app-layout">
                    <Sidebar activeView={activeView} setActiveView={setActiveView} />
                    <main className="main-content">
                        {!dataLoaded ? (
                            <div className="content-section">
                                {loading ? (
                                    <div className="loading-container">
                                        <div className="loading-spinner"></div>
                                        <p className="loading-text">Loading Parse.ly event stream...</p>
                                        <p className="loading-text" style={{marginTop: '0.5rem', opacity: 0.7, fontSize: '0.875rem'}}>
                                            Parsing CSV | Enriching with conversion data | Building indexes
                                        </p>
                                    </div>
                                ) : (
                                    <div className="loading-container">
                                        <h2 style={{marginBottom: '1rem', fontSize: '1.5rem'}}>Welcome to DPL Explorer v2</h2>
                                        <p style={{marginBottom: '2rem', color: 'var(--parsely-gray-600)'}}>
                                            Load Parse.ly raw event data to begin analytics
                                        </p>
                                        <button className="btn btn-primary" onClick={handleLoadData}>
                                            Load Raw Data
                                        </button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <>
                                {activeView === 'journeys' && <JourneysView data={rawData} />}
                                {activeView === 'top-content' && <TopContentView data={rawData} />}
                                {activeView === 'conversions-segments' && <ConversionsSegmentsView data={rawData} />}
                                {activeView === 'segments' && <SegmentsMapView data={rawData} />}
                                {activeView === 'custom-metrics' && <CustomMetricsView data={rawData} />}
                                {activeView === 'cross-domain' && <CrossDomainView data={rawData} />}
                                {activeView === 'scorecard' && <ScorecardView data={rawData} />}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        // ═══════════════════════════════════════════════
        //  SIDEBAR
        // ═══════════════════════════════════════════════

        function Sidebar({ activeView, setActiveView }) {
            const navItems = [
                { id: 'journeys', label: 'Journeys', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 3h4v3H1zM6 4.5h4M11 3h4v3h-4zM3 6v4l5 3M13 6v4l-5 3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>) },
                { id: 'top-content', label: 'Top Content', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2h12M2 5.5h12M2 9h8M2 12.5h10" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/></svg>) },
                { id: 'conversions-segments', label: 'Conversions by Segments', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2l6 4-6 4zM8 6l6 4-6 4z" stroke="currentColor" strokeWidth="1.5" strokeLinejoin="round"/></svg>) },
                { id: 'segments', label: 'Segments', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6" stroke="currentColor" strokeWidth="1.5"/><ellipse cx="8" cy="8" rx="3" ry="6" stroke="currentColor" strokeWidth="1"/><path d="M2 8h12" stroke="currentColor" strokeWidth="1"/></svg>) },
                { id: 'custom-metrics', label: 'Custom Metrics', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 14l3-5 3 3 4-8 4 5" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>) },
                { id: 'cross-domain', label: 'Cross Domain Conversions', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 8h8M9 5l3 3-3 3M7 5L4 8l3 3" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>) },
                { id: 'scorecard', label: 'Scorecard', icon: (<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6" stroke="currentColor" strokeWidth="1.5"/><path d="M8 4v4l3 2" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/></svg>) }
            ];

            return (
                <aside className="sidebar">
                    <div className="logo-container">
                        <div className="logo">
                            <div className="logo-icon">P</div>
                            <div className="logo-text">
                                <div className="logo-title">DPL Explorer</div>
                                <div className="logo-subtitle">Parse.ly Analytics v2</div>
                            </div>
                        </div>
                    </div>
                    <div className="sidebar-section">
                        <div className="sidebar-section-title">Use Cases</div>
                        {navItems.map(item => (
                            <div key={item.id} className={`nav-item ${activeView === item.id ? 'active' : ''}`} onClick={() => setActiveView(item.id)}>
                                <span className="nav-icon">{item.icon}</span>
                                <span>{item.label}</span>
                            </div>
                        ))}
                    </div>
                </aside>
            );
        }

        // ═══════════════════════════════════════════════
        //  CASE 1: JOURNEYS (Evolved Sankey)
        // ═══════════════════════════════════════════════

        function JourneysView({ data }) {
            const sankeyRef = useRef(null);

            useEffect(() => {
                if (!sankeyRef.current) return;
                const container = sankeyRef.current;
                d3.select(container).selectAll("*").remove();

                const width = container.clientWidth;
                const height = 750;
                const margin = { top: 40, right: 30, bottom: 20, left: 30 };
                const innerW = width - margin.left - margin.right;
                const innerH = height - margin.top - margin.bottom;

                const svg = d3.select(container)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                // Tooltip div
                const tooltip = d3.select(container).append("div")
                    .style("position", "absolute").style("background", "#1a2332").style("color", "white")
                    .style("padding", "8px 12px").style("border-radius", "6px").style("font-size", "12px")
                    .style("pointer-events", "none").style("opacity", 0).style("z-index", 10)
                    .style("box-shadow", "0 4px 12px rgba(0,0,0,0.3)");

                const nodes = JOURNEY_NODES;
                const links = JOURNEY_LINKS;

                // Compute total input per node
                const nodeValues = new Array(nodes.length).fill(0);
                links.forEach(l => { nodeValues[l.target] += l.value; });
                // For source nodes with no input, sum their outputs
                links.forEach(l => { if (nodeValues[l.source] === 0) nodeValues[l.source] += l.value; });
                // Re-sum source nodes
                const sourceOutputs = new Array(nodes.length).fill(0);
                links.forEach(l => { sourceOutputs[l.source] += l.value; });
                nodes.forEach((n, i) => { if (nodeValues[i] === 0) nodeValues[i] = sourceOutputs[i]; });

                // Layout: x by stage, y distributed within stage
                const stages = [0, 1, 2, 3, 4, 5, 6];
                const stageX = {};
                const convNodeIdx = 20; // Conversion node index
                stages.forEach(s => {
                    if (s === 6) stageX[s] = innerW - 25;
                    else stageX[s] = (s / 6) * (innerW - 25);
                });

                const nodeWidth = 22;
                const nodePositions = [];

                stages.forEach(stage => {
                    const stageNodes = nodes.map((n, i) => ({ ...n, idx: i })).filter(n => n.stage === stage);
                    const totalValue = stageNodes.reduce((s, n) => s + Math.max(nodeValues[n.idx], 1), 0);
                    const availH = stage === 6 ? innerH - 20 : innerH - 40;
                    const gap = stageNodes.length > 1 ? 12 : 0;
                    const totalGap = gap * (stageNodes.length - 1);
                    const scale = (availH - totalGap) / Math.max(totalValue, 1);

                    let currentY = stage === 6 ? 10 : 20;
                    stageNodes.forEach(n => {
                        const h = Math.max(Math.max(nodeValues[n.idx], 1) * scale, 8);
                        nodePositions[n.idx] = {
                            x: stageX[stage],
                            y: currentY,
                            w: nodeWidth,
                            h: h,
                            name: n.name,
                            stage: n.stage,
                            value: nodeValues[n.idx]
                        };
                        currentY += h + gap;
                    });
                });

                // Colors
                const stageColors = ['#0066cc', '#ff6b35', '#6a4c93', '#17a2b8', '#ffc107', '#e83e8c', '#70A452'];
                const nodeColor = (idx) => {
                    if (idx === convNodeIdx) return '#70A452';
                    return stageColors[nodes[idx].stage] || '#6c757d';
                };

                // Track link offsets for each node
                const nodeSourceOffset = new Array(nodes.length).fill(0);
                const nodeTargetOffset = new Array(nodes.length).fill(0);

                // Sort links by source then target for stable layout
                const sortedLinks = [...links].sort((a, b) => a.source - b.source || a.target - b.target);

                // Draw links
                sortedLinks.forEach(l => {
                    const sn = nodePositions[l.source];
                    const tn = nodePositions[l.target];
                    if (!sn || !tn) return;

                    const sScale = sn.h / Math.max(sourceOutputs[l.source], 1);
                    const totalTargetInput = links.filter(ll => ll.target === l.target).reduce((s, ll) => s + ll.value, 0);
                    const tScale = tn.h / Math.max(totalTargetInput, 1);

                    const linkH_s = l.value * sScale;
                    const linkH_t = l.value * tScale;

                    const sy = sn.y + nodeSourceOffset[l.source];
                    const ty = tn.y + nodeTargetOffset[l.target];
                    nodeSourceOffset[l.source] += linkH_s;
                    nodeTargetOffset[l.target] += linkH_t;

                    const isConvLink = l.target === convNodeIdx;

                    const path = d3.path();
                    const sx = sn.x + sn.w;
                    const tx = tn.x;
                    const cp = (tx - sx) * 0.5;

                    path.moveTo(sx, sy);
                    path.bezierCurveTo(sx + cp, sy, tx - cp, ty, tx, ty);
                    path.lineTo(tx, ty + linkH_t);
                    path.bezierCurveTo(tx - cp, ty + linkH_t, sx + cp, sy + linkH_s, sx, sy + linkH_s);
                    path.closePath();

                    g.append("path")
                        .attr("d", path.toString())
                        .attr("fill", isConvLink ? 'rgba(112, 164, 82, 0.35)' : `${nodeColor(l.source)}22`)
                        .attr("stroke", isConvLink ? '#70A452' : nodeColor(l.source))
                        .attr("stroke-width", 0.5)
                        .attr("stroke-opacity", 0.3)
                        .style("cursor", "pointer")
                        .on("mouseover", function(event) {
                            d3.select(this).attr("fill", isConvLink ? 'rgba(112, 164, 82, 0.6)' : `${nodeColor(l.source)}55`);
                            const totalIn = nodeValues[l.source] || 1;
                            const pct = ((l.value / totalIn) * 100).toFixed(1);
                            tooltip.style("opacity", 1)
                                .html(`<strong>${sn.name} → ${tn.name}</strong><br/>${l.value.toLocaleString()} users (${pct}%)`)
                                .style("left", (event.offsetX + 10) + "px")
                                .style("top", (event.offsetY - 40) + "px");
                        })
                        .on("mousemove", function(event) {
                            tooltip.style("left", (event.offsetX + 10) + "px").style("top", (event.offsetY - 40) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("fill", isConvLink ? 'rgba(112, 164, 82, 0.35)' : `${nodeColor(l.source)}22`);
                            tooltip.style("opacity", 0);
                        });
                });

                // Draw nodes
                nodePositions.forEach((np, idx) => {
                    if (!np) return;
                    const isConv = idx === convNodeIdx;

                    if (isConv) {
                        // Glow
                        g.append("rect").attr("x", np.x - 3).attr("y", np.y - 3)
                            .attr("width", np.w + 6).attr("height", np.h + 6)
                            .attr("fill", "none").attr("stroke", "#70A452").attr("stroke-width", 2)
                            .attr("opacity", 0.4).attr("rx", 8);
                    }

                    g.append("rect")
                        .attr("x", np.x).attr("y", np.y)
                        .attr("width", np.w).attr("height", np.h)
                        .attr("fill", nodeColor(idx))
                        .attr("opacity", 0.9).attr("rx", 4);

                    // Label
                    const labelX = np.stage <= 3 ? np.x + np.w + 6 : np.x - 6;
                    const anchor = np.stage <= 3 ? "start" : "end";
                    if (isConv) {
                        g.append("text").attr("x", np.x + np.w + 8).attr("y", np.y + np.h / 2)
                            .attr("dy", "0.35em").attr("text-anchor", "start")
                            .style("font-size", "13px").style("font-weight", "700").style("fill", "#1a5c2e")
                            .text("Conversion");
                    } else {
                        g.append("text").attr("x", labelX).attr("y", np.y + np.h / 2)
                            .attr("dy", "0.35em").attr("text-anchor", anchor)
                            .style("font-size", "11px").style("font-weight", "600").style("fill", "#495057")
                            .text(np.name);
                    }
                });

                // Stage labels
                const stageLabels = ['Referrers', 'Landings', 'Interest L1', 'Interest L2', 'Interest L3', 'Interest L4', 'Conversion'];
                stages.forEach(s => {
                    g.append("text")
                        .attr("x", stageX[s] + nodeWidth / 2).attr("y", 0)
                        .attr("text-anchor", "middle")
                        .style("font-size", "10px").style("font-weight", "700").style("fill", "#6c757d")
                        .style("text-transform", "uppercase").style("letter-spacing", "0.5px")
                        .text(stageLabels[s]);
                });

            }, [data]);

            // Compute summary metrics
            const totalVisitors = 660;
            const totalConversions = JOURNEY_LINKS.filter(l => l.target === 20).reduce((s, l) => s + l.value, 0);
            const convRate = ((totalConversions / totalVisitors) * 100).toFixed(1);

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">User Journeys</h1>
                            <div className="status-badge"><div className="pulse"></div><span>Live Data</span></div>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Full conversion funnel from referrer to conversion across content depth levels</p>
                    </div>

                    <div className="content-section">
                        <div className="metrics-grid" style={{marginTop: 0}}>
                            <div className="metric-card">
                                <div className="metric-label">Total Visitors</div>
                                <div className="metric-value">{totalVisitors.toLocaleString()}</div>
                            </div>
                            <div className="metric-card">
                                <div className="metric-label">Overall Conversion Rate</div>
                                <div className="metric-value" style={{color: 'var(--parsely-green)'}}>{convRate}%</div>
                            </div>
                            <div className="metric-card">
                                <div className="metric-label">Avg Conversion Value</div>
                                <div className="metric-value">$42.30</div>
                            </div>
                            <div className="metric-card">
                                <div className="metric-label">Most Common Path</div>
                                <div style={{fontSize: '0.9rem', fontWeight: 600, color: 'var(--parsely-gray-800)', marginTop: '0.5rem'}}>Search → Homepage → News Article 1 → Sports Article 1</div>
                            </div>
                        </div>
                    </div>

                    <div className="content-section">
                        <div className="section-header">
                            <h2 className="section-title">Journey Flow</h2>
                            <span style={{fontSize: '0.8rem', color: 'var(--parsely-gray-600)'}}>Hover links for details. Green links = conversions.</span>
                        </div>
                        <div className="sankey-container" ref={sankeyRef} style={{position: 'relative'}}></div>
                    </div>
                </>
            );
        }

        // ═══════════════════════════════════════════════
        //  CASE 2: TOP CONTENT
        // ═══════════════════════════════════════════════

        function TopContentView({ data }) {
            const [sortCol, setSortCol] = useState('uniqueVisitors');
            const [sortDir, setSortDir] = useState('desc');
            const [tooltipData, setTooltipData] = useState(null);
            const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });

            // Aggregate data by article
            const articleMap = {};
            data.forEach(row => {
                const title = row.content_title || row.metadata_title;
                if (!articleMap[title]) {
                    articleMap[title] = { title, visitors: new Set(), pageviews: new Set(), engagedTime: 0, engagedCount: 0, conversions: 0, revenue: 0, subs: 0, newsletters: 0, pdfs: 0 };
                }
                const a = articleMap[title];
                a.visitors.add(row.visitor_site_id);
                // Unique pageviews: unique visitor+url combo
                a.pageviews.add(`${row.visitor_site_id}_${row.url}`);
                a.engagedTime += parseInt(row.engaged_time_inc) || 0;
                a.engagedCount++;
                if (row.conversion_type) {
                    a.conversions++;
                    a.revenue += row.conversion_value || 0;
                    if (row.conversion_type === 'subscription') a.subs++;
                    if (row.conversion_type === 'newsletter') a.newsletters++;
                    if (row.conversion_type === 'pdf_download') a.pdfs++;
                }
            });

            const articles = Object.values(articleMap).map(a => ({
                title: a.title,
                uniqueVisitors: a.visitors.size,
                uniquePageviews: a.pageviews.size,
                engagedTime: a.engagedCount > 0 ? Math.round(a.engagedTime / a.engagedCount) : 0,
                conversions: a.conversions,
                revenue: a.revenue,
                subs: a.subs,
                newsletters: a.newsletters,
                pdfs: a.pdfs
            }));

            const handleSort = (col) => {
                if (sortCol === col) setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                else { setSortCol(col); setSortDir('desc'); }
            };

            const sorted = [...articles].sort((a, b) => {
                const va = a[sortCol], vb = b[sortCol];
                if (typeof va === 'string') return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                return sortDir === 'asc' ? va - vb : vb - va;
            }).slice(0, 20);

            const formatTime = (sec) => {
                const m = Math.floor(sec / 60);
                const s = sec % 60;
                return m > 0 ? `${m}m ${s}s` : `${s}s`;
            };

            const sortIcon = (col) => sortCol === col ? (sortDir === 'asc' ? ' ▲' : ' ▼') : '';

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">Top Content</h1>
                            <div className="status-badge"><div className="pulse"></div><span>{articles.length} Articles</span></div>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Articles ranked by unique visitors. Click column headers to sort.</p>
                    </div>

                    <div className="content-section" style={{position: 'relative'}}>
                        {tooltipData && (
                            <div className="conv-tooltip" style={{left: tooltipPos.x, top: tooltipPos.y, transform: 'translate(-50%, -110%)'}}>
                                <div style={{fontWeight: 700, marginBottom: '4px'}}>Conversion Breakdown</div>
                                <div>Subscriptions: {tooltipData.subs}</div>
                                <div>Newsletters: {tooltipData.newsletters}</div>
                                <div>PDF Downloads: {tooltipData.pdfs}</div>
                            </div>
                        )}
                        <div className="data-table-container">
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th style={{width: '40px'}}>#</th>
                                        <th onClick={() => handleSort('title')}>Article Title{sortIcon('title')}</th>
                                        <th onClick={() => handleSort('uniqueVisitors')}>Unique Visitors{sortIcon('uniqueVisitors')}</th>
                                        <th onClick={() => handleSort('uniquePageviews')}>Unique Pageviews{sortIcon('uniquePageviews')}</th>
                                        <th onClick={() => handleSort('engagedTime')}>Engaged Time{sortIcon('engagedTime')}</th>
                                        <th onClick={() => handleSort('conversions')}>Conversions{sortIcon('conversions')}</th>
                                        <th onClick={() => handleSort('revenue')}>Revenue{sortIcon('revenue')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sorted.map((article, idx) => (
                                        <tr key={idx}>
                                            <td style={{fontWeight: 700, color: 'var(--parsely-gray-400)'}}>{idx + 1}</td>
                                            <td style={{maxWidth: '400px'}}>
                                                <div className="article-row-cell">
                                                    <img className="article-thumb" src={`https://picsum.photos/seed/${encodeURIComponent(article.title.slice(0,10))}/48/48`} alt="" />
                                                    <span style={{fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>{article.title}</span>
                                                </div>
                                            </td>
                                            <td>{article.uniqueVisitors.toLocaleString()}</td>
                                            <td>{article.uniquePageviews.toLocaleString()}</td>
                                            <td>{formatTime(article.engagedTime)}</td>
                                            <td
                                                style={{cursor: 'pointer', fontWeight: 600, color: article.conversions > 0 ? 'var(--parsely-green-dark)' : 'inherit'}}
                                                onMouseEnter={(e) => {
                                                    const rect = e.currentTarget.getBoundingClientRect();
                                                    const parentRect = e.currentTarget.closest('.content-section').getBoundingClientRect();
                                                    setTooltipData({ subs: article.subs, newsletters: article.newsletters, pdfs: article.pdfs });
                                                    setTooltipPos({ x: rect.left - parentRect.left + rect.width / 2, y: rect.top - parentRect.top });
                                                }}
                                                onMouseLeave={() => setTooltipData(null)}
                                            >
                                                {article.conversions}
                                            </td>
                                            <td style={{fontWeight: article.revenue > 0 ? 700 : 400, color: article.revenue > 0 ? 'var(--parsely-green)' : 'inherit'}}>
                                                ${article.revenue.toFixed(2)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            );
        }

        // ═══════════════════════════════════════════════
        //  CASE 3: CONVERSIONS BY SEGMENTS
        // ═══════════════════════════════════════════════

        function ConversionsSegmentsView({ data }) {
            const [conversionType, setConversionType] = useState(null);
            const [segmentType, setSegmentType] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const crossChartRef = useRef(null);
            const crossChartInstance = useRef(null);

            const convOptions = [
                { id: 'subscription', label: 'Subscription', count: data.filter(d => d.conversion_type === 'subscription').length },
                { id: 'newsletter', label: 'Newsletter', count: data.filter(d => d.conversion_type === 'newsletter').length },
                { id: 'pdf_download', label: 'PDF Download', count: data.filter(d => d.conversion_type === 'pdf_download').length }
            ];

            const filtered = conversionType ? data.filter(d => d.conversion_type === conversionType) : [];

            // Build primary chart data
            const primaryBuckets = {};
            if (conversionType && segmentType) {
                filtered.forEach(row => {
                    let key;
                    if (segmentType === 'geo') {
                        key = row.ip_country;
                    } else {
                        try { key = JSON.parse(row.extra_data || '{}').audience_segment || 'Unknown'; } catch { key = 'Unknown'; }
                    }
                    bucketKey(primaryBuckets, key, row);
                });
            }

            function bucketKey(obj, key, row) {
                if (!obj[key]) obj[key] = { count: 0, crossBreakdown: {} };
                obj[key].count++;
                // Always compute the cross-breakdown
                let crossKey;
                if (segmentType === 'geo') {
                    try { crossKey = JSON.parse(row.extra_data || '{}').audience_segment || 'Unknown'; } catch { crossKey = 'Unknown'; }
                } else {
                    crossKey = row.ip_country;
                }
                obj[key].crossBreakdown[crossKey] = (obj[key].crossBreakdown[crossKey] || 0) + 1;
            }

            useEffect(() => {
                if (!chartRef.current || !conversionType || !segmentType) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                const sorted = Object.entries(primaryBuckets).sort((a, b) => b[1].count - a[1].count);
                const labels = sorted.map(s => s[0]);
                const values = sorted.map(s => s[1].count);

                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: `${conversionType.replace('_', ' ')} conversions`,
                            data: values,
                            backgroundColor: labels.map(l => l === selectedItem ? 'rgba(0, 102, 204, 0.8)' : 'rgba(112, 164, 82, 0.7)'),
                            borderColor: labels.map(l => l === selectedItem ? '#0066cc' : '#70A452'),
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const idx = elements[0].index;
                                setSelectedItem(selectedItem === labels[idx] ? null : labels[idx]);
                            }
                        },
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { beginAtZero: true, grid: { color: '#e9ecef' }, ticks: { color: '#6c757d' } },
                            y: { grid: { display: false }, ticks: { color: '#495057', font: { weight: '600' } } }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [conversionType, segmentType, selectedItem, data]);

            // Cross-breakdown for selected item
            const crossData = selectedItem && primaryBuckets[selectedItem] ? primaryBuckets[selectedItem].crossBreakdown : null;

            useEffect(() => {
                if (!crossChartRef.current || !crossData) return;
                if (crossChartInstance.current) crossChartInstance.current.destroy();

                const ctx = crossChartRef.current.getContext('2d');
                const sorted = Object.entries(crossData).sort((a, b) => b[1] - a[1]);

                crossChartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(s => s[0]),
                        datasets: [{
                            label: `${segmentType === 'geo' ? 'Custom Segments' : 'GEOs'} in ${selectedItem}`,
                            data: sorted.map(s => s[1]),
                            backgroundColor: 'rgba(0, 102, 204, 0.6)',
                            borderColor: '#0066cc',
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { beginAtZero: true, grid: { color: '#e9ecef' }, ticks: { color: '#6c757d' } },
                            y: { grid: { display: false }, ticks: { color: '#495057', font: { weight: '600' } } }
                        }
                    }
                });

                return () => { if (crossChartInstance.current) crossChartInstance.current.destroy(); };
            }, [selectedItem, crossData]);

            const convLabel = conversionType ? conversionType.charAt(0).toUpperCase() + conversionType.slice(1).replace('_', ' ') : '';

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">Conversions by Segments</h1>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Select a conversion type, then a segment type. Click a bar for cross-segment breakdown.</p>
                    </div>

                    <div className="content-section">
                        <h3 style={{marginBottom: '0.75rem', fontWeight: 700}}>Step 1: Select Conversion Type</h3>
                        <div className="step-cards">
                            {convOptions.map(opt => (
                                <div key={opt.id} className={`step-card ${conversionType === opt.id ? 'selected' : ''}`} onClick={() => { setConversionType(opt.id); setSelectedItem(null); }}>
                                    <div className="step-card-label">{opt.label}</div>
                                    <div className="step-card-count">{opt.count} conversions</div>
                                </div>
                            ))}
                        </div>

                        {conversionType && (
                            <>
                                <h3 style={{marginTop: '1.5rem', marginBottom: '0.75rem', fontWeight: 700}}>Step 2: Select Segment Type</h3>
                                <div className="toggle-group">
                                    <button className={`toggle-btn ${segmentType === 'geo' ? 'active' : ''}`} onClick={() => { setSegmentType('geo'); setSelectedItem(null); }}>GEO</button>
                                    <button className={`toggle-btn ${segmentType === 'custom' ? 'active' : ''}`} onClick={() => { setSegmentType('custom'); setSelectedItem(null); }}>Custom Segment</button>
                                </div>
                            </>
                        )}

                        {conversionType && segmentType && (
                            <>
                                <h3 style={{marginTop: '1.5rem', marginBottom: '0.75rem', fontWeight: 700}}>
                                    {convLabel} by {segmentType === 'geo' ? 'Geography' : 'Custom Segment'}
                                </h3>
                                <div style={{height: '350px'}}>
                                    <canvas ref={chartRef}></canvas>
                                </div>
                            </>
                        )}

                        {selectedItem && crossData && (
                            <div className="drill-panel">
                                <div className="drill-title">
                                    {selectedItem}: {primaryBuckets[selectedItem].count} {convLabel} conversions — breakdown by {segmentType === 'geo' ? 'Custom Segment' : 'GEO'}
                                    <button onClick={() => setSelectedItem(null)} style={{float: 'right', background: 'none', border: 'none', cursor: 'pointer', fontWeight: 700, color: 'var(--parsely-blue)'}}>Clear</button>
                                </div>
                                <div style={{height: '220px'}}>
                                    <canvas ref={crossChartRef}></canvas>
                                </div>
                            </div>
                        )}
                    </div>
                </>
            );
        }

        // ═══════════════════════════════════════════════
        //  CASE 4: SEGMENTS (with World Map)
        // ═══════════════════════════════════════════════

        function SegmentsMapView({ data }) {
            const [selectedGeo, setSelectedGeo] = useState(null);
            const [selectedAudience, setSelectedAudience] = useState(null);
            const mapRef = useRef(null);
            const [worldData, setWorldData] = useState(null);

            // Fetch world topology
            useEffect(() => {
                fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
                    .then(r => r.json())
                    .then(d => setWorldData(d))
                    .catch(() => {});
            }, []);

            // Geo segments
            const geoSegments = {};
            data.forEach(row => {
                const c = row.ip_country || 'Unknown';
                geoSegments[c] = (geoSegments[c] || 0) + 1;
            });
            const topGeos = Object.entries(geoSegments).sort((a, b) => b[1] - a[1]);

            // Audience segments
            const audienceSegments = {};
            data.forEach(row => {
                try {
                    const ed = JSON.parse(row.extra_data || '{}');
                    const seg = ed.audience_segment || 'Unknown';
                    audienceSegments[seg] = (audienceSegments[seg] || 0) + 1;
                } catch {}
            });

            // Determine highlighted countries
            const getHighlightedCodes = () => {
                const codes = new Set();
                if (selectedGeo) codes.add(selectedGeo);
                if (selectedAudience && AUDIENCE_GEO_MAP[selectedAudience]) {
                    AUDIENCE_GEO_MAP[selectedAudience].forEach(c => codes.add(c));
                }
                return codes;
            };

            // Draw map
            useEffect(() => {
                if (!mapRef.current || !worldData) return;
                const container = mapRef.current;
                d3.select(container).selectAll("*").remove();

                const width = container.clientWidth;
                const height = 520;

                const svg = d3.select(container).append("svg").attr("width", width).attr("height", height);

                const projection = d3.geoNaturalEarth1()
                    .scale(Math.min(width / 5.5, height / 2.8))
                    .translate([width / 2, height / 2]);

                const pathGen = d3.geoPath().projection(projection);

                const countries = topojson.feature(worldData, worldData.objects.countries);
                const highlightCodes = getHighlightedCodes();

                // ISO numeric -> code lookup
                const isoLookup = {};
                COUNTRIES.forEach(c => { isoLookup[c.isoN] = c.code; });

                const tooltip = d3.select(container).append("div")
                    .style("position", "absolute").style("background", "#1a2332").style("color", "white")
                    .style("padding", "6px 10px").style("border-radius", "6px").style("font-size", "11px")
                    .style("pointer-events", "none").style("opacity", 0).style("z-index", 10);

                svg.selectAll("path")
                    .data(countries.features)
                    .join("path")
                    .attr("d", pathGen)
                    .attr("fill", d => {
                        const code = isoLookup[+d.id];
                        if (code && highlightCodes.has(code)) return '#70A452';
                        return '#dde1e7';
                    })
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 0.5)
                    .style("cursor", d => {
                        const code = isoLookup[+d.id];
                        return code ? 'pointer' : 'default';
                    })
                    .on("mouseover", function(event, d) {
                        const code = isoLookup[+d.id];
                        const cInfo = COUNTRIES.find(c => c.code === code);
                        if (cInfo) {
                            d3.select(this).attr("fill", '#5c8f43');
                            tooltip.style("opacity", 1)
                                .html(`<strong>${cInfo.name}</strong><br/>${(geoSegments[code] || 0).toLocaleString()} events`)
                                .style("left", (event.offsetX + 10) + "px")
                                .style("top", (event.offsetY - 30) + "px");
                        }
                    })
                    .on("mousemove", function(event) {
                        tooltip.style("left", (event.offsetX + 10) + "px").style("top", (event.offsetY - 30) + "px");
                    })
                    .on("mouseout", function(event, d) {
                        const code = isoLookup[+d.id];
                        const hl = getHighlightedCodes();
                        d3.select(this).attr("fill", code && hl.has(code) ? '#70A452' : '#dde1e7');
                        tooltip.style("opacity", 0);
                    })
                    .on("click", function(event, d) {
                        const code = isoLookup[+d.id];
                        if (code) setSelectedGeo(selectedGeo === code ? null : code);
                    });

            }, [worldData, selectedGeo, selectedAudience, data]);

            // Cross-segment analysis
            let crossData = { count: 0, revenue: 0, avgEngagement: 0 };
            if (selectedGeo || selectedAudience) {
                const filtered = data.filter(row => {
                    let matchGeo = !selectedGeo || row.ip_country === selectedGeo;
                    let matchAud = !selectedAudience;
                    if (selectedAudience) {
                        try { matchAud = JSON.parse(row.extra_data || '{}').audience_segment === selectedAudience; } catch {}
                    }
                    return matchGeo && matchAud;
                });
                crossData.count = filtered.length;
                crossData.revenue = filtered.reduce((s, r) => s + (r.conversion_value || 0), 0);
                crossData.avgEngagement = filtered.reduce((s, r) => s + (parseInt(r.engaged_time_inc) || 0), 0) / (filtered.length || 1);
            }

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">Audience & Geographic Segments</h1>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Click segments to see cross-analysis. Map syncs with chip selection.</p>
                    </div>

                    <div className="content-section">
                        <div className="segments-container">
                            <div className="segment-panel">
                                <div className="segment-panel-title">Geographic Segments</div>
                                <div className="segment-chips">
                                    {topGeos.map(([country, count]) => (
                                        <div key={country}
                                            className={`segment-chip ${selectedGeo === country ? 'selected' : ''}`}
                                            onClick={() => setSelectedGeo(selectedGeo === country ? null : country)}
                                        >
                                            <span>{country}</span>
                                            <span className="segment-count">{count}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="segment-panel">
                                <div className="segment-panel-title">Custom Audience Segments</div>
                                <div className="segment-chips">
                                    {Object.entries(audienceSegments).map(([segment, count]) => (
                                        <div key={segment}
                                            className={`segment-chip ${selectedAudience === segment ? 'selected' : ''}`}
                                            onClick={() => setSelectedAudience(selectedAudience === segment ? null : segment)}
                                        >
                                            <span>{segment}</span>
                                            <span className="segment-count">{count}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {(selectedGeo || selectedAudience) && (
                            <div className="cross-segment-info">
                                <div className="cross-segment-title">
                                    Cross-Segment Analysis
                                    {selectedGeo && selectedAudience && <span style={{fontWeight: 'normal', marginLeft: '0.5rem'}}>({selectedGeo} x {selectedAudience})</span>}
                                    {selectedGeo && !selectedAudience && <span style={{fontWeight: 'normal', marginLeft: '0.5rem'}}>({selectedGeo})</span>}
                                    {!selectedGeo && selectedAudience && <span style={{fontWeight: 'normal', marginLeft: '0.5rem'}}>({selectedAudience})</span>}
                                </div>
                                <div className="cross-segment-stats">
                                    <div className="cross-segment-stat"><span>Total Events:</span><span className="cross-segment-stat-value">{crossData.count.toLocaleString()}</span></div>
                                    <div className="cross-segment-stat"><span>Total Revenue:</span><span className="cross-segment-stat-value">${crossData.revenue.toFixed(2)}</span></div>
                                    <div className="cross-segment-stat"><span>Avg Engagement:</span><span className="cross-segment-stat-value">{crossData.avgEngagement.toFixed(1)}s</span></div>
                                </div>
                            </div>
                        )}

                        <div className="world-map-container" ref={mapRef} style={{position: 'relative'}}></div>
                    </div>
                </>
            );
        }

        // ═══════════════════════════════════════════════
        //  CASE 5: CUSTOM METRICS
        // ═══════════════════════════════════════════════

        function CustomMetricsView({ data }) {
            const [selectedPreset, setSelectedPreset] = useState(null);

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">Custom Metrics</h1>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Default gauges and charts always visible. Create custom metrics below.</p>
                    </div>

                    {/* Default metric cards */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Key Metric Gauges</h2></div>
                        <GaugeRow data={data} />
                    </div>

                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Engagement Over Time</h2></div>
                        <AreaChartWidget data={data} />
                    </div>

                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Performance Radar (Current vs Previous)</h2></div>
                        <RadarChartWidget data={data} />
                    </div>

                    <div className="content-section">
                        <div className="section-header">
                            <h2 className="section-title">Other Custom Metrics</h2>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)', marginBottom: '1rem'}}>Choose a predefined metric to generate instantly.</p>
                        <div className="preset-cards">
                            <div className={`preset-card ${selectedPreset === 'referrer' ? 'active' : ''}`} onClick={() => setSelectedPreset('referrer')}>
                                <div className="preset-card-title">Engagement by Referrer Source</div>
                                <div className="preset-card-desc">Dual-axis: bars for avg engaged time + line for conversion rate</div>
                            </div>
                            <div className={`preset-card ${selectedPreset === 'radar' ? 'active' : ''}`} onClick={() => setSelectedPreset('radar')}>
                                <div className="preset-card-title">Content Performance Radar</div>
                                <div className="preset-card-desc">Radar chart: Interest, Engagement, Reach, Conversion (current vs previous)</div>
                            </div>
                            <div className={`preset-card ${selectedPreset === 'heatmap' ? 'active' : ''}`} onClick={() => setSelectedPreset('heatmap')}>
                                <div className="preset-card-title">Conversion Funnel Heatmap</div>
                                <div className="preset-card-desc">Time-of-day heatmap showing conversion distribution by day of week</div>
                            </div>
                        </div>

                        {selectedPreset === 'referrer' && <ReferrerDualAxisChart data={data} />}
                        {selectedPreset === 'radar' && <ContentRadarChart data={data} />}
                        {selectedPreset === 'heatmap' && <ConversionHeatmap data={data} />}
                    </div>
                </>
            );
        }

        function GaugeRow({ data }) {
            const gaugeRef1 = useRef(null);
            const gaugeRef2 = useRef(null);

            const avgInterest = data.reduce((s, r) => {
                try { return s + (JSON.parse(r.extra_data || '{}').article_interest || 0); } catch { return s; }
            }, 0) / data.length;
            const avgEngagement = data.reduce((s, r) => {
                try { return s + (JSON.parse(r.extra_data || '{}').article_engagement || 0); } catch { return s; }
            }, 0) / data.length;

            const drawGauge = (ref, value, maxVal, label) => {
                if (!ref.current) return;
                d3.select(ref.current).selectAll("*").remove();
                const size = 140;
                const svg = d3.select(ref.current).append("svg").attr("width", size).attr("height", size / 2 + 30);
                const g = svg.append("g").attr("transform", `translate(${size/2},${size/2})`);

                const arc = d3.arc().innerRadius(45).outerRadius(60).startAngle(-Math.PI / 2);
                // Background
                g.append("path").attr("d", arc.endAngle(Math.PI / 2)()).attr("fill", "#e9ecef");
                // Value
                const scale = d3.scaleLinear().domain([0, maxVal]).range([-Math.PI / 2, Math.PI / 2]);
                g.append("path").attr("d", arc.endAngle(scale(value))()).attr("fill", "#70A452");
                g.append("text").attr("y", -5).attr("text-anchor", "middle")
                    .style("font-size", "22px").style("font-weight", "800").style("fill", "#1a2332")
                    .text(value.toFixed(1));
                g.append("text").attr("y", 15).attr("text-anchor", "middle")
                    .style("font-size", "10px").style("fill", "#6c757d").text(`/ ${maxVal}`);
            };

            useEffect(() => {
                drawGauge(gaugeRef1, avgInterest, 5, 'Interest');
                drawGauge(gaugeRef2, avgEngagement, 5, 'Engagement');
            }, [data]);

            return (
                <div className="gauge-grid">
                    <div className="gauge-card">
                        <div ref={gaugeRef1}></div>
                        <div className="gauge-label">Article Interest</div>
                    </div>
                    <div className="gauge-card">
                        <div ref={gaugeRef2}></div>
                        <div className="gauge-label">Engagement Score</div>
                    </div>
                    <div className="gauge-card">
                        <div className="gauge-value" style={{marginTop: '1rem'}}>{(data.filter(d => d.conversion_type).length / data.length * 100).toFixed(1)}%</div>
                        <div className="gauge-label">Conversion Rate</div>
                    </div>
                    <div className="gauge-card">
                        <div className="gauge-value" style={{marginTop: '1rem'}}>{Math.round(data.reduce((s, r) => s + (parseInt(r.engaged_time_inc) || 0), 0) / data.length)}s</div>
                        <div className="gauge-label">Avg Engaged Time</div>
                    </div>
                </div>
            );
        }

        function AreaChartWidget({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                // Group by hour
                const hours = Array.from({length: 24}, (_, i) => i);
                const engByHour = hours.map(h => {
                    const hd = data.filter(d => d.ts_action && new Date(d.ts_action).getHours() === h);
                    return hd.reduce((s, d) => s + (parseInt(d.engaged_time_inc) || 0), 0) / (hd.length || 1);
                });

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours.map(h => `${h}:00`),
                        datasets: [{
                            label: 'Avg Engagement (seconds)',
                            data: engByHour,
                            borderColor: '#70A452',
                            backgroundColor: (ctx) => {
                                const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(112, 164, 82, 0.4)');
                                gradient.addColorStop(1, 'rgba(112, 164, 82, 0.02)');
                                return gradient;
                            },
                            borderWidth: 3, fill: true, tension: 0.4,
                            pointBackgroundColor: '#70A452', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#212529', font: { size: 12, weight: '600' } } } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#e9ecef' }, ticks: { color: '#6c757d' } },
                            x: { grid: { color: '#e9ecef' }, ticks: { color: '#6c757d', maxTicksLimit: 12 } }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <div className="chart-container"><canvas ref={chartRef}></canvas></div>;
        }

        function RadarChartWidget({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                const metrics = ['article_interest', 'article_engagement', 'purposeful_reach', 'conversion_rate_score'];
                const labels = ['Interest', 'Engagement', 'Reach', 'Conversion'];

                const current = metrics.map(m => {
                    const vals = data.map(d => { try { return JSON.parse(d.extra_data || '{}')[m] || 0; } catch { return 0; } });
                    return vals.reduce((a, b) => a + b, 0) / vals.length;
                });
                const previous = current.map(v => v * (0.7 + Math.random() * 0.4));

                chartInstance.current = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Current Period', data: current, borderColor: '#70A452', backgroundColor: 'rgba(112,164,82,0.2)', borderWidth: 3, pointBackgroundColor: '#70A452' },
                            { label: 'Previous Period', data: previous, borderColor: '#6c757d', backgroundColor: 'rgba(108,117,125,0.1)', borderWidth: 2, borderDash: [5, 5], pointBackgroundColor: '#6c757d' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { r: { beginAtZero: true, max: 5, ticks: { stepSize: 1 }, grid: { color: '#e9ecef' }, pointLabels: { font: { size: 13, weight: '600' }, color: '#495057' } } },
                        plugins: { legend: { labels: { color: '#212529', font: { size: 12, weight: '600' } } } }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <div className="chart-container"><canvas ref={chartRef}></canvas></div>;
        }

        function ReferrerDualAxisChart({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                const buckets = {};
                data.forEach(d => {
                    const ref = d.referrer_type || 'Unknown';
                    if (!buckets[ref]) buckets[ref] = { totalTime: 0, count: 0, conversions: 0 };
                    buckets[ref].totalTime += parseInt(d.engaged_time_inc) || 0;
                    buckets[ref].count++;
                    if (d.conversion_type) buckets[ref].conversions++;
                });

                const labels = Object.keys(buckets);
                const avgTimes = labels.map(l => buckets[l].totalTime / buckets[l].count);
                const convRates = labels.map(l => (buckets[l].conversions / buckets[l].count * 100));

                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { type: 'bar', label: 'Avg Engaged Time (s)', data: avgTimes, backgroundColor: 'rgba(112,164,82,0.7)', borderColor: '#70A452', borderWidth: 2, borderRadius: 6, yAxisID: 'y' },
                            { type: 'line', label: 'Conversion Rate (%)', data: convRates, borderColor: '#0066cc', backgroundColor: 'transparent', borderWidth: 3, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#0066cc', yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#212529', font: { size: 12, weight: '600' } } } },
                        scales: {
                            y: { position: 'left', beginAtZero: true, grid: { color: '#e9ecef' }, ticks: { color: '#70A452' }, title: { display: true, text: 'Avg Engaged Time (s)', color: '#70A452' } },
                            y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, ticks: { color: '#0066cc' }, title: { display: true, text: 'Conversion Rate (%)', color: '#0066cc' } },
                            x: { grid: { display: false }, ticks: { color: '#495057', font: { weight: '600' } } }
                        }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <div style={{height: '380px', marginTop: '1.5rem'}}><canvas ref={chartRef}></canvas></div>;
        }

        function ContentRadarChart({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = chartRef.current.getContext('2d');
                const sections = ['News', 'Sports', 'Politics', 'Tech', 'Culture'];
                const metrics = ['article_interest', 'article_engagement', 'purposeful_reach', 'conversion_rate_score'];
                const metricLabels = ['Interest', 'Engagement', 'Reach', 'Conversion'];

                const datasets = sections.map((sec, i) => {
                    const secData = data.filter(d => d.metadata_section === sec);
                    const values = metrics.map(m => {
                        const vals = secData.map(d => { try { return JSON.parse(d.extra_data || '{}')[m] || 0; } catch { return 0; } });
                        return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
                    });
                    const colors = ['#70A452', '#0066cc', '#ff6b35', '#6a4c93', '#17a2b8'];
                    return { label: sec, data: values, borderColor: colors[i], backgroundColor: `${colors[i]}22`, borderWidth: 2, pointBackgroundColor: colors[i] };
                });

                chartInstance.current = new Chart(ctx, {
                    type: 'radar',
                    data: { labels: metricLabels, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { r: { beginAtZero: true, max: 5, ticks: { stepSize: 1 }, grid: { color: '#e9ecef' }, pointLabels: { font: { size: 13, weight: '600' }, color: '#495057' } } },
                        plugins: { legend: { labels: { color: '#212529', font: { size: 11, weight: '600' } } } }
                    }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data]);

            return <div style={{height: '400px', marginTop: '1.5rem'}}><canvas ref={chartRef}></canvas></div>;
        }

        function ConversionHeatmap({ data }) {
            const heatRef = useRef(null);

            useEffect(() => {
                if (!heatRef.current) return;
                d3.select(heatRef.current).selectAll("*").remove();

                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const hours = Array.from({length: 24}, (_, i) => i);

                // Build matrix
                const matrix = days.map(() => hours.map(() => 0));
                data.forEach(d => {
                    if (!d.conversion_type || !d.ts_action) return;
                    const dt = new Date(d.ts_action);
                    const day = (dt.getDay() + 6) % 7; // Mon=0
                    const hour = dt.getHours();
                    matrix[day][hour]++;
                });

                const maxVal = Math.max(1, ...matrix.flat());
                const width = heatRef.current.clientWidth;
                const cellW = Math.max(16, (width - 60) / 24);
                const cellH = 30;
                const margin = { top: 30, left: 50 };
                const height = margin.top + days.length * cellH + 20;

                const svg = d3.select(heatRef.current).append("svg").attr("width", width).attr("height", height);
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const colorScale = d3.scaleSequential(d3.interpolateGreens).domain([0, maxVal]);

                days.forEach((day, di) => {
                    hours.forEach((hour, hi) => {
                        g.append("rect")
                            .attr("x", hi * cellW).attr("y", di * cellH)
                            .attr("width", cellW - 2).attr("height", cellH - 2)
                            .attr("rx", 3).attr("fill", colorScale(matrix[di][hi]));
                    });
                    g.append("text").attr("x", -8).attr("y", di * cellH + cellH / 2)
                        .attr("text-anchor", "end").attr("dy", "0.35em")
                        .style("font-size", "11px").style("font-weight", "600").style("fill", "#495057")
                        .text(day);
                });

                hours.forEach(h => {
                    if (h % 3 === 0) {
                        g.append("text").attr("x", h * cellW + cellW / 2).attr("y", -8)
                            .attr("text-anchor", "middle")
                            .style("font-size", "10px").style("fill", "#6c757d")
                            .text(`${h}:00`);
                    }
                });

            }, [data]);

            return <div ref={heatRef} style={{marginTop: '1.5rem'}}></div>;
        }

        // ═══════════════════════════════════════════════
        //  CASE 6: CROSS DOMAIN CONVERSIONS
        // ═══════════════════════════════════════════════

        // Sankey data for cross-domain flow
        const CROSS_DOMAIN_SANKEY_NODES = [
            { id: 'www', label: 'www.site.com', x: 0, color: '#3b82f6' },
            { id: 'shop', label: 'shop.site.com', x: 1, color: '#f59e0b' },
            { id: 'paywall', label: 'paywall.site.com', x: 1, color: '#8b5cf6' },
            { id: 'subscribe', label: 'subscribe.site.com', x: 1, color: '#ec4899' },
            { id: 'purchase', label: 'Purchase', x: 2, color: '#70A452' },
            { id: 'premium', label: 'Premium Access', x: 2, color: '#70A452' },
            { id: 'newsletter', label: 'Newsletter Signup', x: 2, color: '#70A452' },
        ];
        const CROSS_DOMAIN_SANKEY_LINKS = [
            { source: 'www', target: 'shop', value: 1850 },
            { source: 'www', target: 'paywall', value: 3200 },
            { source: 'www', target: 'subscribe', value: 4100 },
            { source: 'shop', target: 'purchase', value: 342 },
            { source: 'paywall', target: 'premium', value: 567 },
            { source: 'subscribe', target: 'newsletter', value: 891 },
        ];

        function CrossDomainView({ data }) {
            const sankeyRef = useRef(null);
            const [codeTab, setCodeTab] = useState('sender');

            // Draw the subdomain Sankey
            useEffect(() => {
                if (!sankeyRef.current) return;
                const container = sankeyRef.current;
                d3.select(container).selectAll("*").remove();

                const width = container.clientWidth;
                const height = 340;
                const svg = d3.select(container).append("svg").attr("width", width).attr("height", height);
                const margin = { top: 20, right: 20, bottom: 20, left: 20 };
                const w = width - margin.left - margin.right;
                const h = height - margin.top - margin.bottom;
                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const nodes = CROSS_DOMAIN_SANKEY_NODES;
                const links = CROSS_DOMAIN_SANKEY_LINKS;

                // Compute node positions
                const stages = [0, 1, 2];
                const stageX = { 0: 0, 1: w * 0.42, 2: w * 0.84 };
                const nodeWidth = 18;
                const nodesByStage = stages.map(s => nodes.filter(n => n.x === s));

                // Compute node heights proportional to throughput
                const nodeValues = {};
                nodes.forEach(n => { nodeValues[n.id] = 0; });
                links.forEach(l => { nodeValues[l.source] += l.value; nodeValues[l.target] += l.value; });
                const maxVal = Math.max(...Object.values(nodeValues));

                const nodePositions = {};
                nodesByStage.forEach((stageNodes, si) => {
                    const totalVal = stageNodes.reduce((s, n) => s + nodeValues[n.id], 0);
                    const gap = 18;
                    const availH = h - gap * (stageNodes.length - 1);
                    let y = 0;
                    if (si === 0) { y = h * 0.15; } // center the single source node
                    stageNodes.forEach((n, i) => {
                        const nodeH = Math.max(30, (nodeValues[n.id] / maxVal) * availH * 0.75);
                        if (si === 0) {
                            nodePositions[n.id] = { x: stageX[si], y: (h - nodeH) / 2, h: nodeH, w: nodeWidth };
                        } else {
                            nodePositions[n.id] = { x: stageX[si], y, h: nodeH, w: nodeWidth };
                            y += nodeH + gap;
                        }
                    });
                    // Vertically center each stage
                    const totalHeight = y - gap;
                    const offset = (h - totalHeight) / 2;
                    if (si !== 0 && offset > 0) {
                        stageNodes.forEach(n => { nodePositions[n.id].y += offset; });
                    }
                });

                // Track source/target offsets for ribbon layout
                const sourceOffsets = {};
                const targetOffsets = {};
                nodes.forEach(n => { sourceOffsets[n.id] = 0; targetOffsets[n.id] = 0; });

                // Draw links
                const tooltip = d3.select("body").append("div")
                    .style("position", "absolute").style("background", "rgba(0,0,0,0.85)")
                    .style("color", "white").style("padding", "6px 12px").style("border-radius", "6px")
                    .style("font-size", "12px").style("pointer-events", "none").style("opacity", 0)
                    .style("z-index", 9999).attr("class", "cd-sankey-tooltip");

                links.forEach(link => {
                    const src = nodePositions[link.source];
                    const tgt = nodePositions[link.target];
                    const srcNode = nodes.find(n => n.id === link.source);
                    const tgtNode = nodes.find(n => n.id === link.target);
                    const srcTotal = links.filter(l => l.source === link.source).reduce((s, l) => s + l.value, 0);
                    const tgtTotal = links.filter(l => l.target === link.target).reduce((s, l) => s + l.value, 0);

                    const ribbonH_src = (link.value / srcTotal) * src.h;
                    const ribbonH_tgt = (link.value / tgtTotal) * tgt.h;
                    const sy = src.y + sourceOffsets[link.source];
                    const ty = tgt.y + targetOffsets[link.target];
                    sourceOffsets[link.source] += ribbonH_src;
                    targetOffsets[link.target] += ribbonH_tgt;

                    const x0 = src.x + src.w;
                    const x1 = tgt.x;
                    const mx = (x0 + x1) / 2;

                    const path = d3.path();
                    path.moveTo(x0, sy);
                    path.bezierCurveTo(mx, sy, mx, ty, x1, ty);
                    path.lineTo(x1, ty + ribbonH_tgt);
                    path.bezierCurveTo(mx, ty + ribbonH_tgt, mx, sy + ribbonH_src, x0, sy + ribbonH_src);
                    path.closePath();

                    g.append("path")
                        .attr("d", path.toString())
                        .attr("fill", srcNode.color)
                        .attr("opacity", 0.35)
                        .style("cursor", "pointer")
                        .on("mouseover", function(event) {
                            d3.select(this).attr("opacity", 0.6);
                            const pct = ((link.value / nodeValues[link.source]) * 100).toFixed(1);
                            tooltip.html(`<strong>${srcNode.label} → ${tgtNode.label}</strong><br/>${link.value.toLocaleString()} users (${pct}%)`)
                                .style("left", (event.pageX + 12) + "px").style("top", (event.pageY - 28) + "px").style("opacity", 1);
                        })
                        .on("mousemove", function(event) {
                            tooltip.style("left", (event.pageX + 12) + "px").style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("opacity", 0.35);
                            tooltip.style("opacity", 0);
                        });
                });

                // Draw nodes
                nodes.forEach(n => {
                    const pos = nodePositions[n.id];
                    g.append("rect")
                        .attr("x", pos.x).attr("y", pos.y)
                        .attr("width", pos.w).attr("height", pos.h)
                        .attr("rx", 4).attr("fill", n.color);

                    // Label
                    const isLeft = n.x === 0;
                    const isRight = n.x === 2;
                    const labelX = isLeft ? pos.x - 8 : (isRight ? pos.x + pos.w + 8 : pos.x + pos.w + 8);
                    const anchor = isLeft ? "end" : "start";

                    g.append("text")
                        .attr("x", labelX).attr("y", pos.y + pos.h / 2 - 6)
                        .attr("text-anchor", anchor)
                        .style("font-size", "12px").style("font-weight", "700").style("fill", "#1a2332")
                        .text(n.label);
                    g.append("text")
                        .attr("x", labelX).attr("y", pos.y + pos.h / 2 + 10)
                        .attr("text-anchor", anchor)
                        .style("font-size", "11px").style("fill", "#6c757d")
                        .text(nodeValues[n.id].toLocaleString() + ' users');
                });

                // Stage labels
                const stageLabels = ['Main Site', 'Subdomains', 'Conversions'];
                stages.forEach((s, i) => {
                    g.append("text")
                        .attr("x", stageX[s] + nodeWidth / 2).attr("y", -4)
                        .attr("text-anchor", "middle")
                        .style("font-size", "11px").style("font-weight", "700").style("fill", "#9ca3af")
                        .style("text-transform", "uppercase").style("letter-spacing", "0.05em")
                        .text(stageLabels[i]);
                });

                return () => { d3.selectAll(".cd-sankey-tooltip").remove(); };
            }, []);

            const codeSnippetSender = `<span class="code-comment">// On www.site.com — append visitor ID to subdomain links</span>
<span class="code-keyword">const</span> <span class="code-var">visitorId</span> = PARSELY.<span class="code-func">getVisitorId</span>();

<span class="code-comment">// For each link pointing to a subdomain</span>
document.<span class="code-func">querySelectorAll</span>(<span class="code-string">'a[href*="shop.site.com"], a[href*="paywall.site.com"], a[href*="subscribe.site.com"]'</span>)
  .<span class="code-func">forEach</span>(link => {
    <span class="code-keyword">const</span> <span class="code-var">url</span> = <span class="code-keyword">new</span> <span class="code-func">URL</span>(link.href);
    url.searchParams.<span class="code-func">set</span>(<span class="code-string">'_puid'</span>, <span class="code-var">visitorId</span>);
    link.href = url.<span class="code-func">toString</span>();
  });`;

            const codeSnippetReceiver = `<span class="code-comment">// On subdomain (shop.site.com, etc.) — capture the passed ID</span>
<span class="code-keyword">const</span> <span class="code-var">params</span> = <span class="code-keyword">new</span> <span class="code-func">URLSearchParams</span>(window.location.search);
<span class="code-keyword">const</span> <span class="code-var">passthroughUid</span> = <span class="code-var">params</span>.<span class="code-func">get</span>(<span class="code-string">'_puid'</span>);

<span class="code-keyword">if</span> (<span class="code-var">passthroughUid</span>) {
  <span class="code-comment">// Store in extra_data so it's sent with every event</span>
  PARSELY.<span class="code-func">setExtraData</span>({
    <span class="code-string">'passthrough_uid'</span>: <span class="code-var">passthroughUid</span>,
    <span class="code-string">'original_domain'</span>: <span class="code-string">'www.site.com'</span>
  });
}`;

            const codeSnippetUnify = `<span class="code-comment"># Post-processing: Unify journeys (Python / BigQuery)</span>
<span class="code-keyword">SELECT</span>
  COALESCE(e.extra_data.passthrough_uid, e.visitor_site_id) <span class="code-keyword">AS</span> <span class="code-var">unified_visitor_id</span>,
  e.action,
  e.url,
  e.metadata.title,
  e.ts_action
<span class="code-keyword">FROM</span> <span class="code-string">\`project.dataset.rawdata\`</span> e
<span class="code-keyword">ORDER BY</span> <span class="code-var">unified_visitor_id</span>, e.ts_action`;

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">Cross Domain Conversions</h1>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Understanding and solving the subdomain user-id tracking problem.</p>
                    </div>

                    {/* Problem panel */}
                    <div className="panel-problem">
                        <div className="panel-title">The Problem: User-ID Resets on Subdomain Navigation</div>
                        <p style={{lineHeight: 1.8}}>
                            When a user navigates from <strong>www.site.com</strong> to a subdomain like <strong>shop.site.com</strong>,
                            the Parse.ly tracker generates a <strong>new visitor_site_id</strong>. This creates fragmented journeys:
                            the same user appears as two different visitors, making it impossible to attribute conversions
                            on subdomains back to the original content engagement on the main site.
                        </p>
                    </div>

                    {/* Solution panel */}
                    <div className="panel-solution">
                        <div className="panel-title">The Solution: Pass User-ID via Query String + Post-Processing</div>
                        <p style={{lineHeight: 1.8}}>
                            Append the original <code style={{background: 'rgba(0,0,0,0.06)', padding: '2px 6px', borderRadius: '4px'}}>visitor_site_id</code> as a query parameter
                            when linking to subdomains. Store this in <strong>extra_data</strong>. In post-processing, unify journeys by matching
                            the <code style={{background: 'rgba(0,0,0,0.06)', padding: '2px 6px', borderRadius: '4px'}}>passthrough_uid</code> with the original <code style={{background: 'rgba(0,0,0,0.06)', padding: '2px 6px', borderRadius: '4px'}}>visitor_site_id</code>.
                        </p>
                    </div>

                    {/* Subdomain Sankey */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Subdomain Traffic Flow</h2></div>
                        <p style={{color: 'var(--parsely-gray-600)', fontSize: '0.85rem', marginBottom: '0.5rem'}}>
                            How visitors flow from the main site through subdomains to conversions. Hover over flows to see details.
                        </p>
                        <div ref={sankeyRef} style={{width: '100%'}}></div>
                    </div>

                    {/* User journey timeline */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Example User Journey</h2></div>
                        <p style={{color: 'var(--parsely-gray-600)', fontSize: '0.85rem', marginBottom: '1rem'}}>
                            A real example showing how a single user's journey spans domains — and how the passthrough ID unifies it.
                        </p>
                        <div className="journey-timeline">
                            <div className="timeline-step step-main">
                                <div className="step-time">10:23:15 AM</div>
                                <div className="step-domain" style={{color: '#3b82f6'}}>www.site.com</div>
                                <div className="step-action">User lands on homepage from Google Search</div>
                                <div className="step-id">visitor_site_id: <strong>v_8f3a2b1c</strong></div>
                            </div>
                            <div className="timeline-step step-main">
                                <div className="step-time">10:24:42 AM</div>
                                <div className="step-domain" style={{color: '#3b82f6'}}>www.site.com/politics/climate-summit</div>
                                <div className="step-action">Reads "Climate Summit" article (3m 18s engaged time)</div>
                                <div className="step-id">visitor_site_id: <strong>v_8f3a2b1c</strong></div>
                            </div>
                            <div className="timeline-step step-main">
                                <div className="step-time">10:28:01 AM</div>
                                <div className="step-domain" style={{color: '#3b82f6'}}>www.site.com/tech/ai-revolution</div>
                                <div className="step-action">Reads "AI Revolution" article (2m 45s engaged time)</div>
                                <div className="step-id">visitor_site_id: <strong>v_8f3a2b1c</strong></div>
                            </div>

                            <div className="timeline-break">
                                <span className="timeline-break-label break-red">ID RESET without solution</span>
                                <span className="timeline-break-label break-green">ID PRESERVED with _puid</span>
                            </div>

                            <div className="timeline-step step-cross">
                                <div className="step-time">10:30:47 AM</div>
                                <div className="step-domain" style={{color: '#f59e0b'}}>subscribe.site.com<span style={{color: '#70A452', fontWeight: 400}}>?_puid=v_8f3a2b1c</span></div>
                                <div className="step-action">Clicks "Subscribe" CTA — navigates to subscription subdomain</div>
                                <div className="step-id">
                                    new visitor_site_id: <strong style={{color: '#dc2626', textDecoration: 'line-through'}}>v_new_9x7k</strong>{' '}
                                    <span style={{color: '#70A452'}}>extra_data.passthrough_uid: <strong>v_8f3a2b1c</strong></span>
                                </div>
                            </div>
                            <div className="timeline-step step-unified">
                                <div className="step-time">10:32:35 AM</div>
                                <div className="step-domain" style={{color: '#70A452'}}>subscribe.site.com/confirm</div>
                                <div className="step-action" style={{color: '#16a34a', fontWeight: 600}}>Completes newsletter subscription ($9.99/mo)</div>
                                <div className="step-id">
                                    unified_visitor_id: <strong style={{color: '#70A452'}}>v_8f3a2b1c</strong>{' '}
                                    <span style={{background: '#f0fdf4', padding: '1px 6px', borderRadius: '4px', fontSize: '0.65rem', color: '#16a34a', fontWeight: 700}}>MATCHED</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Code snippet */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Implementation</h2></div>
                        <p style={{color: 'var(--parsely-gray-600)', fontSize: '0.85rem', marginBottom: '1rem'}}>
                            Three pieces needed: the sender (main site), the receiver (subdomain), and the post-processing query.
                        </p>
                        <div className="code-tab-bar">
                            <div className={`code-tab ${codeTab === 'sender' ? 'active' : ''}`} onClick={() => setCodeTab('sender')}>
                                Sender (Main Site)
                            </div>
                            <div className={`code-tab ${codeTab === 'receiver' ? 'active' : ''}`} onClick={() => setCodeTab('receiver')}>
                                Receiver (Subdomain)
                            </div>
                            <div className={`code-tab ${codeTab === 'unify' ? 'active' : ''}`} onClick={() => setCodeTab('unify')}>
                                Post-Processing (SQL)
                            </div>
                        </div>
                        <pre className="code-block" style={{marginTop: 0, borderTopLeftRadius: 0}}
                             dangerouslySetInnerHTML={{__html: codeTab === 'sender' ? codeSnippetSender : codeTab === 'receiver' ? codeSnippetReceiver : codeSnippetUnify}} />
                    </div>

                    {/* Subdomain conversion table */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Subdomain Conversion Table</h2></div>
                        <div className="data-table-container">
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Subdomain</th>
                                        <th>Description</th>
                                        <th>Conversions</th>
                                        <th>Unique Users</th>
                                        <th>Revenue</th>
                                        <th>Avg Time to Convert</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {CROSS_DOMAIN_TABLE.map((row, idx) => (
                                        <tr key={idx}>
                                            <td style={{fontWeight: 600, fontFamily: 'monospace'}}>{row.subdomain}</td>
                                            <td>{row.description}</td>
                                            <td style={{fontWeight: 600, color: row.conversions ? 'var(--parsely-green-dark)' : 'var(--parsely-gray-400)'}}>
                                                {row.conversions !== null ? row.conversions.toLocaleString() : '—'}
                                            </td>
                                            <td>{row.uniqueUsers.toLocaleString()}</td>
                                            <td style={{fontWeight: row.revenue ? 700 : 400, color: row.revenue ? 'var(--parsely-green)' : 'var(--parsely-gray-400)'}}>
                                                {row.revenue !== null ? `$${row.revenue.toLocaleString()}` : '—'}
                                            </td>
                                            <td>{row.avgTimeToConvert || '—'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Before/After comparison */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Before / After Comparison</h2></div>
                        <div className="comparison-grid">
                            <div className="comparison-card comparison-before">
                                <h3 style={{color: '#dc2626', marginBottom: '1rem', fontSize: '1.1rem', fontWeight: 700}}>Before: Fragmented Data</h3>
                                <div style={{lineHeight: 2}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px solid #fca5a5', padding: '0.25rem 0'}}>
                                        <span style={{fontWeight: 600}}>www.site.com</span>
                                        <span>Visitor A reads 5 articles</span>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px solid #fca5a5', padding: '0.25rem 0'}}>
                                        <span style={{fontWeight: 600}}>shop.site.com</span>
                                        <span style={{color: '#dc2626', fontWeight: 600}}>Unknown Visitor B purchases $89</span>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.25rem 0'}}>
                                        <span style={{fontWeight: 600}}>Attribution</span>
                                        <span style={{color: '#dc2626', fontWeight: 700}}>BROKEN — no link between A and B</span>
                                    </div>
                                </div>
                                <div style={{marginTop: '1rem', padding: '0.75rem', background: 'rgba(220,38,38,0.1)', borderRadius: '8px', fontSize: '0.85rem', fontWeight: 600, color: '#dc2626'}}>
                                    Content ROI: Unknown. Cannot prove articles drive purchases.
                                </div>
                            </div>

                            <div className="comparison-card comparison-after">
                                <h3 style={{color: '#16a34a', marginBottom: '1rem', fontSize: '1.1rem', fontWeight: 700}}>After: Unified Journey</h3>
                                <div style={{lineHeight: 2}}>
                                    <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px solid #86efac', padding: '0.25rem 0'}}>
                                        <span style={{fontWeight: 600}}>www.site.com</span>
                                        <span>Visitor A reads 5 articles</span>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px solid #86efac', padding: '0.25rem 0'}}>
                                        <span style={{fontWeight: 600}}>shop.site.com</span>
                                        <span style={{color: '#16a34a', fontWeight: 600}}>Same Visitor A purchases $89</span>
                                    </div>
                                    <div style={{display: 'flex', justifyContent: 'space-between', padding: '0.25rem 0'}}>
                                        <span style={{fontWeight: 600}}>Attribution</span>
                                        <span style={{color: '#16a34a', fontWeight: 700}}>LINKED — full content-to-purchase path</span>
                                    </div>
                                </div>
                                <div style={{marginTop: '1rem', padding: '0.75rem', background: 'rgba(22,163,74,0.1)', borderRadius: '8px', fontSize: '0.85rem', fontWeight: 600, color: '#16a34a'}}>
                                    Content ROI: Proven. Articles 3 & 5 drove the $89 purchase.
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        }

        // ═══════════════════════════════════════════════
        //  CASE 7: SCORECARD
        // ═══════════════════════════════════════════════

        // Hardcoded score profiles per article — intentionally varied
        const ARTICLE_SCORE_PROFILES = [
            { interest: 5, engagement: 5, reach: 4, conversion: 5 }, // Climate Summit — top performer
            { interest: 4, engagement: 5, reach: 5, conversion: 4 }, // Tech Giants — strong
            { interest: 5, engagement: 4, reach: 3, conversion: 2 }, // Championship — great interest, poor conversion
            { interest: 3, engagement: 3, reach: 3, conversion: 3 }, // Mediterranean Diet — average
            { interest: 2, engagement: 2, reach: 3, conversion: 1 }, // Housing Market — underperformer
            { interest: 4, engagement: 3, reach: 5, conversion: 4 }, // SpaceX — good reach
            { interest: 5, engagement: 4, reach: 4, conversion: 3 }, // Political Tensions — high interest
            { interest: 1, engagement: 2, reach: 1, conversion: 1 }, // Streaming Wars — poor across the board
            { interest: 5, engagement: 5, reach: 5, conversion: 5 }, // AI Revolution — star performer
            { interest: 3, engagement: 2, reach: 2, conversion: 1 }, // Olympic Athletes — meh
            { interest: 2, engagement: 1, reach: 2, conversion: 2 }, // Cryptocurrency — struggling
            { interest: 4, engagement: 4, reach: 3, conversion: 3 }, // Wildfire Season — solid
            { interest: 5, engagement: 4, reach: 4, conversion: 4 }, // Electric Vehicle — trending
            { interest: 3, engagement: 3, reach: 4, conversion: 5 }, // Supreme Court — great conversion
            { interest: 1, engagement: 1, reach: 2, conversion: 1 }, // Broadway Returns — bottom
            { interest: 4, engagement: 5, reach: 3, conversion: 2 }, // Cybersecurity — high engagement
            { interest: 2, engagement: 3, reach: 1, conversion: 3 }, // World Cup — low reach
            { interest: 3, engagement: 4, reach: 4, conversion: 4 }, // Remote Work — steady
            { interest: 4, engagement: 3, reach: 5, conversion: 3 }, // Tourism — great reach
            { interest: 1, engagement: 2, reach: 1, conversion: 2 }  // Opioid Crisis — needs work
        ];

        function ScorecardView({ data }) {
            const radarRef = useRef(null);
            const radarInstance = useRef(null);
            const [sortCol, setSortCol] = useState('overall');
            const [sortDir, setSortDir] = useState('desc');

            // Build articles with hardcoded scores
            const articles = ARTICLE_TITLES.map((title, idx) => {
                const scores = ARTICLE_SCORE_PROFILES[idx] || { interest: 3, engagement: 3, reach: 3, conversion: 3 };
                const section = ['News', 'Tech', 'Sports', 'News', 'News', 'Tech', 'Politics', 'Culture', 'Tech', 'Sports', 'Tech', 'News', 'Tech', 'Politics', 'Culture', 'Tech', 'Sports', 'News', 'News', 'News'][idx] || 'News';
                const overall = (scores.interest + scores.engagement + scores.reach + scores.conversion) / 4;
                return { title, section, ...scores, overall };
            });

            const handleSort = (col) => {
                if (sortCol === col) setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                else { setSortCol(col); setSortDir('desc'); }
            };

            const sorted = [...articles].sort((a, b) => {
                const va = a[sortCol], vb = b[sortCol];
                if (typeof va === 'string') return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                return sortDir === 'asc' ? va - vb : vb - va;
            });

            const sortIcon = (col) => sortCol === col ? (sortDir === 'asc' ? ' ▲' : ' ▼') : '';

            // Summary stats
            const avgOverall = articles.reduce((s, a) => s + a.overall, 0) / articles.length;
            const topPerformers = articles.filter(a => a.overall >= 4).length;
            const needsAttention = articles.filter(a => a.overall < 2.5).length;
            const avgInterest = (articles.reduce((s, a) => s + a.interest, 0) / articles.length).toFixed(1);
            const avgEngagement = (articles.reduce((s, a) => s + a.engagement, 0) / articles.length).toFixed(1);

            // Radar chart by section
            useEffect(() => {
                if (!radarRef.current) return;
                if (radarInstance.current) radarInstance.current.destroy();

                const ctx = radarRef.current.getContext('2d');
                const sections = [...new Set(articles.map(a => a.section))];
                const metrics = ['interest', 'engagement', 'reach', 'conversion'];
                const metricLabels = ['Interest', 'Engagement', 'Reach', 'Conversion'];
                const colors = ['#70A452', '#0066cc', '#ff6b35', '#6a4c93', '#17a2b8'];

                const datasets = sections.slice(0, 5).map((sec, i) => {
                    const secArticles = articles.filter(a => a.section === sec);
                    const values = metrics.map(m => {
                        const vals = secArticles.map(a => a[m]);
                        return vals.length > 0 ? vals.reduce((s, v) => s + v, 0) / vals.length : 0;
                    });
                    return {
                        label: sec,
                        data: values,
                        borderColor: colors[i],
                        backgroundColor: `${colors[i]}20`,
                        borderWidth: 2,
                        pointBackgroundColor: colors[i],
                        pointRadius: 4
                    };
                });

                radarInstance.current = new Chart(ctx, {
                    type: 'radar',
                    data: { labels: metricLabels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true, max: 5, ticks: { stepSize: 1, display: false },
                                grid: { color: '#e9ecef' },
                                pointLabels: { font: { size: 14, weight: '700' }, color: '#495057' }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#212529', font: { size: 12, weight: '600' }, padding: 20, usePointStyle: true }
                            }
                        }
                    }
                });

                return () => { if (radarInstance.current) radarInstance.current.destroy(); };
            }, [data]);

            const getAvgClass = (v) => v >= 3.5 ? 'high' : v >= 2.5 ? 'mid' : 'low';

            return (
                <>
                    <div className="header">
                        <div className="header-top">
                            <h1 className="page-title">Golden Metrics Scorecard</h1>
                            <div className="status-badge"><div className="pulse"></div><span>Live Scoring</span></div>
                        </div>
                        <p style={{color: 'var(--parsely-gray-600)'}}>Each article scored 1-5 against expected performance for similar content. Click headers to sort.</p>
                    </div>

                    {/* Summary stats */}
                    <div className="scorecard-summary">
                        <div className="scorecard-stat">
                            <div className={`scorecard-stat-value ${getAvgClass(avgOverall)}`}>{avgOverall.toFixed(1)}</div>
                            <div className="scorecard-stat-label">Avg Overall Score</div>
                        </div>
                        <div className="scorecard-stat">
                            <div className="scorecard-stat-value" style={{color: '#28a745'}}>{topPerformers}</div>
                            <div className="scorecard-stat-label">Top Performers (4+)</div>
                        </div>
                        <div className="scorecard-stat">
                            <div className="scorecard-stat-value" style={{color: needsAttention > 0 ? '#dc3545' : 'var(--parsely-gray-400)'}}>{needsAttention}</div>
                            <div className="scorecard-stat-label">Needs Attention (&lt;2.5)</div>
                        </div>
                        <div className="scorecard-stat">
                            <div className="scorecard-stat-value" style={{color: 'var(--parsely-blue)'}}>{avgInterest}</div>
                            <div className="scorecard-stat-label">Avg Interest</div>
                        </div>
                        <div className="scorecard-stat">
                            <div className="scorecard-stat-value" style={{color: 'var(--accent-purple)'}}>{avgEngagement}</div>
                            <div className="scorecard-stat-label">Avg Engagement</div>
                        </div>
                    </div>

                    {/* Score scale explanation */}
                    <div className="content-section">
                        <div className="scorecard-explanation">
                            <h3>How the Scorecard Works</h3>
                            <p style={{marginBottom: '1rem', lineHeight: '1.8'}}>
                                Each article is scored on a <strong>1-5 scale</strong> by comparing actual performance
                                against expected performance for similar content, positions, and contexts.
                            </p>
                            <div className="score-scale">
                                <div className="score-item score-1"><div className="score-number">1</div><div className="score-label">Significantly Below</div><div className="score-percentage">~8%</div></div>
                                <div className="score-item score-2"><div className="score-number">2</div><div className="score-label">Below</div><div className="score-percentage">~17%</div></div>
                                <div className="score-item score-3"><div className="score-number">3</div><div className="score-label">Meets</div><div className="score-percentage">~50%</div></div>
                                <div className="score-item score-4"><div className="score-number">4</div><div className="score-label">Above</div><div className="score-percentage">~17%</div></div>
                                <div className="score-item score-5"><div className="score-number">5</div><div className="score-label">Significantly Above</div><div className="score-percentage">~8%</div></div>
                            </div>
                            <div style={{marginTop: '1rem'}}>
                                <strong style={{color: 'var(--parsely-blue)'}}>Metrics:</strong>
                                <span style={{marginLeft: '0.5rem', color: 'var(--parsely-gray-700)', fontSize: '0.875rem'}}>
                                    Interest (CTR vs expected) | Engagement (reading time vs expected) | Reach (quality traffic sources) | Conversion (subscriber/purchase rate)
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Radar by section */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Performance by Section</h2></div>
                        <div style={{height: '380px'}}><canvas ref={radarRef}></canvas></div>
                    </div>

                    {/* Scorecard table */}
                    <div className="content-section">
                        <div className="section-header"><h2 className="section-title">Article Scores</h2></div>
                        <div className="data-table-container" style={{marginTop: 0}}>
                            <table className="scorecard-table">
                                <thead>
                                    <tr>
                                        <th style={{textAlign: 'left', width: '35%', cursor: 'pointer'}} onClick={() => handleSort('title')}>Article{sortIcon('title')}</th>
                                        <th style={{cursor: 'pointer'}} onClick={() => handleSort('section')}>Section{sortIcon('section')}</th>
                                        <th style={{cursor: 'pointer'}} onClick={() => handleSort('interest')}>Interest{sortIcon('interest')}</th>
                                        <th style={{cursor: 'pointer'}} onClick={() => handleSort('engagement')}>Engagement{sortIcon('engagement')}</th>
                                        <th style={{cursor: 'pointer'}} onClick={() => handleSort('reach')}>Reach{sortIcon('reach')}</th>
                                        <th style={{cursor: 'pointer'}} onClick={() => handleSort('conversion')}>Conversion{sortIcon('conversion')}</th>
                                        <th style={{cursor: 'pointer'}} onClick={() => handleSort('overall')}>Overall{sortIcon('overall')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sorted.map((article, idx) => (
                                        <tr key={idx} style={{transition: 'background 0.2s'}} onMouseEnter={e => e.currentTarget.style.background = 'var(--parsely-green-light)'} onMouseLeave={e => e.currentTarget.style.background = ''}>
                                            <td style={{maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap'}}>
                                                {article.title}
                                            </td>
                                            <td><span style={{background: 'var(--parsely-gray-100)', padding: '0.25rem 0.6rem', borderRadius: '12px', fontSize: '0.75rem', fontWeight: 600}}>{article.section}</span></td>
                                            <td><span className={`score-cell score-${article.interest}`}>{article.interest}</span></td>
                                            <td><span className={`score-cell score-${article.engagement}`}>{article.engagement}</span></td>
                                            <td><span className={`score-cell score-${article.reach}`}>{article.reach}</span></td>
                                            <td><span className={`score-cell score-${article.conversion}`}>{article.conversion}</span></td>
                                            <td><span className={`avg-score ${getAvgClass(article.overall)}`}>{article.overall.toFixed(1)}</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            );
        }

        // ═══════════════════════════════════════════════
        //  RENDER
        // ═══════════════════════════════════════════════

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
